# 导出云文档概述

导出云文档指将飞书文档、电子表格、多维表格导出为本地文件，包括 Word、Excel、PDF、CSV 格式。本文档介绍导出云文档的完整步骤。

## 注意事项

你需及时下载导出的文件。在导出任务结束 10 分钟后，导出的文件将被删除，导致无法下载。

## 启用水印说明

当企业内部启用水印时：
- 使用应用身份（tenant_access_token）进行导出，将会使用应用 ID 作为水印，比如 `cli_a2c2xxxxxxxxd01b`；
- 使用用户身份（user_access_token）进行导出，将会使用用户标识作为水印。

## 支持导出的文件类型

OpenAPI 支持将以下飞书云文档导出为以下文件类型。

| 飞书云文档 | 支持导出的文件类型 |
| ---------- | ------------------ |
-   [新版在线文档](https://open.feishu.cn/document/ukTMukTMukTM/uUDN04SN0QjL1QDN/document-docx/docx-overview)（docx）<br>- [旧版在线文档](https://open.feishu.cn/document/ukTMukTMukTM/uUDN04SN0QjL1QDN/docs/upgraded-docs-access-guide/upgraded-docs-openapi-access-guide)（doc）（历史版本，已不推荐使用） | - 扩展名为 docx 的 Microsoft Word 文档<br>**注意事项**：导出为 Microsoft Word 文档时，文档内资源大小总计不可超过 1 GB，否则将导出失败。<br>- 扩展名为 pdf 的文件<br>**注意事项**：导出为 PDF 文件时，文档内资源大小总计不可超过 128 MB，否则将导出失败。
- [多维表格](https://open.feishu.cn/document/ukTMukTMukTM/uUDN04SN0QjL1QDN/bitable-overview)<br>- [电子表格](https://open.feishu.cn/document/ukTMukTMukTM/uATMzUjLwEzM14CMxMTN/overview) | - 扩展名为 xlsx 的 Microsoft Excel 表格<br>- 扩展名为 csv 的文件

## 导出步骤

### 步骤一：创建导出任务

调用[创建导出任务](https://open.feishu.cn/document/uAjLw4CM/ukTMukTMukTM/reference/drive-v1/export_task/create)接口，创建导出云文档的任务并获取导出 ID。
**注意事项**：如果要导出类型为知识库（`wiki`）的文档，你需要先通过[获取知识空间节点信息](https://open.feishu.cn/document/ukTMukTMukTM/uUDN04SN0QjL1QDN/wiki-v2/space/get_node)得到节点对应的`obj_token`（文档 Token）和`obj_type`（文档类型），然后再创建导出任务。

### 步骤二：查询导出任务结果

调用[查询导出任务结果](https://open.feishu.cn/document/uAjLw4CM/ukTMukTMukTM/reference/drive-v1/export_task/get)接口，根据步骤一返回的导出任务 ID（`ticket`）获取导出结果和导出文件信息。

### 步骤三：下载导出文件

调用[下载导出文件](https://open.feishu.cn/document/uAjLw4CM/ukTMukTMukTM/reference/drive-v1/export_task/download)接口，根据步骤二返回的导出文件的 `token` 下载导出文件。
**注意事项**：你需及时下载导出的文件。在导出任务结束 10 分钟后，导出的文件将被删除，导致无法下载。

# 创建导出任务

该接口用于创建导出文件的任务，并返回导出任务 ID。导出文件指将飞书文档、电子表格、多维表格导出为本地文件，包括 Word、Excel、PDF、CSV 格式。该接口为异步接口，需要继续调用[查询导出任务结果](https://open.feishu.cn/document/uAjLw4CM/ukTMukTMukTM/reference/drive-v1/export_task/get)接口获取导出结果。了解完整的导出步骤，参考[导出云文档概述](https://open.feishu.cn/document/uAjLw4CM/ukTMukTMukTM/reference/drive-v1/export_task/export-user-guide)。

## 请求

| 基本                                                         | &nbsp;                                                       |
| ------------------------------------------------------------ | ------------------------------------------------------------ |
| HTTP URL                                                     | https://open.feishu.cn/open-apis/drive/v1/export_tasks       |
| HTTP Method                                                  | POST                                                         |
| 接口频率限制                                                 | [100 次/分钟](https://open.feishu.cn/document/ukTMukTMukTM/uUzN04SN3QjL1cDN) |
| 支持的应用类型                                               | Custom App                                                   |
| 权限要求<br>**调用该 API 所需的权限。开启其中任意一项权限即可调用**<br>开启任一权限即可 | 导出云文档(docs:document:export)<br>导出云文档(drive:export:readonly) |

### 请求头

| 名称          | 类型   | 必填 | 描述                                                         |
| ------------- | ------ | ---- | ------------------------------------------------------------ |
| Authorization | string | 是   | `tenant_access_token`<br>或<br>`user_access_token`<br>**值格式**："Bearer `access_token`"<br>**示例值**："Bearer u-7f1bcd13fc57d46bac21793a18e560"<br>[了解更多：如何选择与获取 access token](https://open.feishu.cn/document/uAjLw4CM/ugTN1YjL4UTN24CO1UjN/trouble-shooting/how-to-choose-which-type-of-token-to-use) |
| Content-Type  | string | 是   | **固定值**："application/json; charset=utf-8"                |

### 请求体

| 名称           | 类型   | 必填 | 描述                                                         |
| -------------- | ------ | ---- | ------------------------------------------------------------ |
| file_extension | string | 是   | 将云文档导出为本地文件后，本地文件的扩展名。了解各类云文档支持导出的文件格式，参考[导出云文档概述](https://open.feishu.cn/document/uAjLw4CM/ukTMukTMukTM/reference/drive-v1/export_task/export-user-guide)。<br>**示例值**："csv"<br>**可选值有**：<br>- docx：Microsoft Word 格式<br>- pdf：PDF 格式<br>- xlsx：Microsoft Excel 格式<br>- csv：CSV 格式 |
| token          | string | 是   | 要导出的云文档的 token。获取方式参考 [如何获取云文档相关 token](https://open.feishu.cn/document/ukTMukTMukTM/uczNzUjL3czM14yN3MTN#08bb5df6)。<br>**示例值**："Fm7osyjtMh5o7Ktrv32c73abcef"<br>**数据校验规则**：<br>- 最大长度：`27` 字符 |
| type           | string | 是   | 要导出的云文档的类型 。可通过云文档的链接判断。<br>**示例值**："sheet"<br>**可选值有**：<br>- doc：旧版飞书文档。支持导出扩展名为 docx 和 pdf 的文件。已不推荐使用。<br>- sheet：飞书电子表格。支持导出扩展名为 xlsx 和 csv 的文件。<br>- bitable：飞书多维表格。支持导出扩展名为 xlsx 和 csv 格式的文件。<br>- docx：新版飞书文档。支持导出扩展名为 docx 和 pdf 格式的文件。 |
| sub_id         | string | 否   | 导出飞书电子表格或多维表格为 CSV 文件时，需传入电子表格工作表的 ID 或多维表格数据表的 ID：<br>- 电子表格可调用[获取工作表](https://open.feishu.cn/document/ukTMukTMukTM/uUDN04SN0QjL1QDN/sheets-v3/spreadsheet-sheet/query) 接口获取返回的 `sheet_id` 的值作为该参数的值<br>- 多维表格可调用[列出数据表](https://open.feishu.cn/document/uAjLw4CM/ukTMukTMukTM/reference/bitable-v1/app-table/list)接口获取返回的 `table_id` 的值作为该参数的值<br>**示例值**："6e5ed3" |

### 请求体示例
```json
{
    "file_extension": "csv",
    "token": "Fm7osyjtMh5o7Ktrv32c73abcef",
    "type": "sheet",
    "sub_id": "6e5ed3"
}
```

## 响应

### 响应体

| 名称   | 类型   | 描述                  |
| ------ | ------ | --------------------- |
| code   | int    | 错误码，非 0 表示失败 |
| msg    | string | 错误描述              |
| data   | \-     | \-                    |
| ticket | string | 导出任务的 ID         |

### 响应体示例
```json
{
    "code": 0,
    "msg": "success",
    "data": {
        "ticket": "6933093124755423251"
    }
}
```

### 错误码

| HTTP状态码 | 错误码  | 描述                                  | 排查建议                                                     |
| ---------- | ------- | ------------------------------------- | ------------------------------------------------------------ |
| 500        | 1069901 | internal error                        | 服务内部错误。请联系[技术支持](https://applink.feishu.cn/client/helpdesk/open) |
| 403        | 1069902 | no permission                         | 当前访问身份没有文档阅读或编辑权限。请参考以下方式解决：<br>- 如果你使用的是 `tenant_access_token`，意味着当前应用没有文档阅读或编辑权限。你需通过云文档网页页面右上方 **「...」** -> **「...更多」** ->**「添加文档应用」** 入口为应用添加文档权限。<br>- 如果你使用的是 `user_access_token`，意味着当前用户没有文档阅读或编辑权限。你需通过云文档网页页面右上方 **分享** 入口为当前用户添加文档权限。<br>了解具体操作步骤或其它添加权限方式，参考[云文档常见问题 3](https://open.feishu.cn/document/ukTMukTMukTM/uczNzUjL3czM14yN3MTN#16c6475a)。 |
| 400        | 1069904 | invalid param                         | 无效参数。请检查导出 CSV 文件时是否传入电子表格中工作表的 ID |
| 404        | 1069906 | docs deleted                          | 文档已被删除                                                 |
| 404        | 1069914 | invalid file token                    | 导出文档 token 不合法。参考[云文档常见问题](https://open.feishu.cn/document/ukTMukTMukTM/uczNzUjL3czM14yN3MTN#08bb5df6)了解如何获取文档 token。 |
| 400        | 1069918 | file extension and  <br>type mismatch | 导出文件类型与云文档类型不匹配                               |
| 429        | 1069923 | too many requests                     | 请求发生限频，请降低请求频率并稍后重试                       |

| HTTP状态码 | 错误码 | 描述                    | 排查建议                                   |
| ---------- | ------ | ----------------------- | ------------------------------------------ |
| 200        | 600    | hybrid resource expired | 混合部署数据已转移到私有化机房，请稍后重试 |

其他错误码可参考：[服务端错误码说明](https://open.feishu.cn/document/ukTMukTMukTM/ugjM14COyUjL4ITN)

# 查询导出任务结果

根据[创建导出任务](https://open.feishu.cn/document/uAjLw4CM/ukTMukTMukTM/reference/drive-v1/export_task/create)返回的导出任务 ID（ticket）轮询导出任务结果，并返回导出文件的 token。你可使用该 token 继续调用[下载导出文件](https://open.feishu.cn/document/uAjLw4CM/ukTMukTMukTM/reference/drive-v1/export_task/download)接口将导出的产物下载到本地。了解完整的导出文件步骤，参考[导出飞书云文档概述](https://open.feishu.cn/document/uAjLw4CM/ukTMukTMukTM/reference/drive-v1/export_task/export-user-guide)。

## 注意事项

调用该接口的用户或应用需与调用创建导出任务接口的用户或应用保持一致。

## 请求

| 基本                                                         | &nbsp;                                                       |
| ------------------------------------------------------------ | ------------------------------------------------------------ |
| HTTP URL                                                     | https://open.feishu.cn/open-apis/drive/v1/export_tasks/:ticket |
| HTTP Method                                                  | GET                                                          |
| 接口频率限制                                                 | [100 次/分钟](https://open.feishu.cn/document/ukTMukTMukTM/uUzN04SN3QjL1cDN) |
| 支持的应用类型                                               | Custom App                                                   |
| 权限要求<br>**调用该 API 所需的权限。开启其中任意一项权限即可调用**<br>开启任一权限即可 | 导出云文档(docs:document:export)<br>导出云文档(drive:export:readonly) |

### 请求头

| 名称          | 类型   | 必填 | 描述                                                         |
| ------------- | ------ | ---- | ------------------------------------------------------------ |
| Authorization | string | 是   | `tenant_access_token`<br>或<br>`user_access_token`<br>**值格式**："Bearer `access_token`"<br>**示例值**："Bearer u-7f1bcd13fc57d46bac21793a18e560"<br>[了解更多：如何选择与获取 access token](https://open.feishu.cn/document/uAjLw4CM/ugTN1YjL4UTN24CO1UjN/trouble-shooting/how-to-choose-which-type-of-token-to-use) |

### 路径参数

| 名称   | 类型   | 描述                                                         |
| ------ | ------ | ------------------------------------------------------------ |
| ticket | string | 导出任务 ID。调用[创建导出任务](https://open.feishu.cn/document/uAjLw4CM/ukTMukTMukTM/reference/drive-v1/export_task/create) 获取。<br>**示例值**："6933093124755412345" |

### 查询参数

| 名称  | 类型   | 必填 | 描述                                                         |
| ----- | ------ | ---- | ------------------------------------------------------------ |
| token | string | 是   | 要导出的云文档的 token。获取方式参考[如何获取云文档相关 token](https://open.feishu.cn/document/ukTMukTMukTM/uczNzUjL3czM14yN3MTN#08bb5df6)。你可参考以下请求示例了解如何使用查询参数。<br>**示例值**：docbcZVGtv1papC6jAVGiyabcef<br>**数据校验规则**：<br>- 最大长度：`27` 字符 |

### 请求示例
```bash
curl --location --request GET 'https://open.feishu.cn/open-apis/drive/v1/export_tasks/7143131813848809492?token=docbcZVGtv1papC6jAVGiyabcef' \
--header 'Authorization: Bearer t-g1029efgIY34MWD1L4CEYQOVN5TZF2OMPJXTDVOP'
```

## 响应

### 响应体

| 名称           | 类型        | 描述                                                         |
| -------------- | ----------- | ------------------------------------------------------------ |
| code           | int         | 错误码，非 0 表示失败                                        |
| msg            | string      | 错误描述                                                     |
| data           | \-          | \-                                                           |
| result         | export_task | 导出任务结果                                                 |
| file_extension | string      | 导出的文件的扩展名<br>**可选值有**：<br>- docx：Microsoft Word 格式<br>- pdf：PDF 格式<br>- xlsx：Microsoft Excel (XLSX) 格式<br>- csv：CSV 格式 |
| type           | string      | 要导出的云文档的类型。可通过云文档的链接判断。<br>**可选值有**：<br>- doc：旧版飞书文档。支持导出扩展名为 docx 和 pdf 的文件。已不推荐使用。<br>- sheet：飞书电子表格。支持导出扩展名为 xlsx 和 csv 的文件<br>- bitable：飞书多维表格。支持导出扩展名为 xlsx 和 csv 格式的文件<br>- docx：新版飞书文档。支持导出扩展名为 docx 和 pdf 格式的文件 |
| file_name      | string      | 导出的文件名称                                               |
| file_token     | string      | 导出的文件的 token。可用于调用[下载导出文件](https://open.feishu.cn/document/uAjLw4CM/ukTMukTMukTM/reference/drive-v1/export_task/download)接口将导出的产物下载到本地。 |
| file_size      | int         | 导出文件的大小，单位字节。                                   |
| job_error_msg  | string      | 导出任务失败的原因                                           |
| job_status     | int         | 导出任务状态<br>**可选值有**：<br>- 0：成功<br>- 1：初始化<br>- 2：处理中<br>- 3：内部错误<br>- 107：导出文档过大<br>- 108：处理超时<br>- 109：导出内容块无权限<br>- 110：无权限<br>- 111：导出文档已删除<br>- 122：创建副本中禁止导出<br>- 123：导出文档不存在<br>- 6000：导出文档图片过多 |

### 响应体示例
```json
{
    "code": 0,
    "msg": "success",
    "data": {
        "result": {
            "file_extension": "pdf",
            "type": "doc",
            "file_name": "docName",
            "file_token": "boxcnxe5OdjlAkNgSNdsJvabcef",
            "file_size": 34356,
            "job_error_msg": "success",
            "job_status": 0
        }
    }
}
```

### 错误码

| HTTP状态码 | 错误码  | 描述           | 排查建议                                                     |
| ---------- | ------- | -------------- | ------------------------------------------------------------ |
| 500        | 1069901 | internal error | 服务内部错误，请联系[技术支持](https://open.feishu.cn/document/ukTMukTMukTM/uUDN04SN0QjL1QDN/docs-overview#51f94b41) |
| 403        | 1069902 | no permission  | 当前访问身份没有文档阅读或编辑权限。请参考以下方式解决：<br>- 如果你使用的是 `tenant_access_token`，意味着当前应用没有文档阅读或编辑权限。你需通过云文档网页页面右上方 **「...」** -> **「...更多」** ->**「添加文档应用」** 入口为应用添加文档权限。<br>- 如果你使用的是 `user_access_token`，意味着当前用户没有文档阅读或编辑权限。你需通过云文档网页页面右上方 **分享** 入口为当前用户添加文档权限。<br>了解具体操作步骤或其它添加权限方式，参考[云文档常见问题 3](https://open.feishu.cn/document/ukTMukTMukTM/uczNzUjL3czM14yN3MTN#16c6475a)。 |
| 400        | 1069904 | invalid param  | 无效参数，导出 csv 是否传入 sub_id                           |
| 410        | 1069906 | docs deleted   | 文档已被删除                                                 |

其他错误码可参考：[服务端错误码说明](https://open.feishu.cn/document/ukTMukTMukTM/ugjM14COyUjL4ITN)

# 下载导出文件

根据[查询导出任务结果](https://open.feishu.cn/document/uAjLw4CM/ukTMukTMukTM/reference/drive-v1/export_task/get)返回的导出文件的 token，下载导出产物到本地。了解完整的导出文件步骤，参考[导出云文档概述](https://open.feishu.cn/document/uAjLw4CM/ukTMukTMukTM/reference/drive-v1/export_task/export-user-guide)。

## 注意事项

你需及时下载导出的文件。在导出任务结束 10 分钟后，导出的文件将被删除，导致无法下载。

## 请求

| 基本                                                         | &nbsp;                                                       |
| ------------------------------------------------------------ | ------------------------------------------------------------ |
| HTTP URL                                                     | https://open.feishu.cn/open-apis/drive/v1/export_tasks/file/:file_token/download |
| HTTP Method                                                  | GET                                                          |
| 接口频率限制                                                 | [100 次/分钟](https://open.feishu.cn/document/ukTMukTMukTM/uUzN04SN3QjL1cDN) |
| 支持的应用类型                                               | Custom App                                                   |
| 权限要求<br>**调用该 API 所需的权限。开启其中任意一项权限即可调用**<br>开启任一权限即可 | 导出云文档(docs:document:export)<br>导出云文档(drive:export:readonly) |

### 请求头

| 名称          | 类型   | 必填 | 描述                                                         |
| ------------- | ------ | ---- | ------------------------------------------------------------ |
| Authorization | string | 是   | `tenant_access_token`<br>或<br>`user_access_token`<br>**值格式**："Bearer `access_token`"<br>**示例值**："Bearer u-7f1bcd13fc57d46bac21793a18e560"<br>[了解更多：如何选择与获取 access token](https://open.feishu.cn/document/uAjLw4CM/ugTN1YjL4UTN24CO1UjN/trouble-shooting/how-to-choose-which-type-of-token-to-use) |

### 路径参数

| 名称       | 类型   | 描述                                                         |
| ---------- | ------ | ------------------------------------------------------------ |
| file_token | string | 导出的文件的 token。可通过调用[查询导出任务结果](https://open.feishu.cn/document/uAjLw4CM/ukTMukTMukTM/reference/drive-v1/export_task/get)获取该参数的值。<br>**示例值**："boxcnxe5OdjlAkNgSNdsJvabcef" |

## 响应

HTTP状态码为 200 时，表示成功

返回文件二进制流

### 错误码

| HTTP状态码 | 错误码  | 描述             | 排查建议   |
| ---------- | ------- | ---------------- | ---------- |
| 400        | 1060001 | param is invalid | 参数错误。 |

# 流程概述

飞书开放平台提供的 API 遵循 RESTful 风格，请求 URL 的格式如下图所示。

![](//sf3-cn.feishucdn.com/obj/open-platform-opendoc/aa8920622dec1a7c41bdf36cc80e4e6c_An5yZkSEI7.png?height=145&lazyload=true&maxWidth=750&width=1280)

## 快速入门

你可参考以下教程快速体验如何调用服务端 API：
- [快速调用一个服务端 API（以发送
消息接口为例）](https://open.feishu.cn/document/uAjLw4CM/uMzNwEjLzcDMx4yM3ATM/how-to-call-a-server-side-api/introduction)
- [快速调用一个服务端 API（以创建多维表格为例）](https://open.feishu.cn/document/uAjLw4CM/uMzNwEjLzcDMx4yM3ATM/call-a-server-api-base-example/introduction)

## 流程概述
调用服务端 API 的流程和说明如下所示。

![API概述zh.png](//sf3-cn.feishucdn.com/obj/open-platform-opendoc/5ca2db50685db2af90c99d46a7ccb87f_Z0QZjf9ahO.png?height=214&lazyload=true&maxWidth=800&width=2276)

1. 创建应用。在[开发者后台](https://open.feishu.cn/app)，根据实际需求，创建自建应用或者商店应用。
    仅拥有 ISV 资质的用户可以创建商店应用。有关 ISV 的详细介绍，请参考[如何入驻飞书开放平台](https://open.feishu.cn/document/uMzNwEjLzcDMx4yM3ATM/uUzNwEjL1cDMx4SN3ATM)。

2. [获取访问凭证](https://open.feishu.cn/document/ukTMukTMukTM/uMTNz4yM1MjLzUzM)。飞书开放平台设置了多种访问凭证（也称为 `access_token`），不同的访问凭证代表了不同的资源访问权限。调用 API 时，必须在 HTTP Header 中携带访问凭证，以便获取权限范围内的资源信息。   

3. [申请 API 权限](https://open.feishu.cn/document/ukTMukTMukTM/uQjN3QjL0YzN04CN2cDN)。不同的 API 有不同的接口权限和字段权限要求。如需调用 API 则需先申请相匹配的 API 权限。如果涉及到访问敏感字段，还需申请访问敏感字段的权限。

4. [（可选）配置应用数据权限](https://open.feishu.cn/document/home/introduction-to-scope-and-authorization/configure-app-data-permissions)。应用的数据权限是指以应用身份访问业务资源时可获取的数据范围。当应用申请了部分 API 的权限（例如，通讯录、飞书人事企业版）后，还需要配置相应的数据权限并提交审核。待审核通过后权限生效，才可以成功调用 API 获取数据。不在应用数据权限范围内的资源将无法成功获取到数据。

5. [（可选）设置 IP 白名单](https://open.feishu.cn/document/ukTMukTMukTM/ucTMxYjL3ETM24yNxEjN)。为了提升应用的安全性，可以为应用设置 IP 白名单。仅当发起请求的源 IP 在白名单内时，飞书开放平台才会响应，否则请求将被拒绝。

6. [调用 API](https://open.feishu.cn/document/ukTMukTMukTM/ukDNz4SO0MjL5QzM/get-)。当你根据实际需要完成以上配置步骤后，即可开始调用 API，API 的具体介绍与参数说明可以参考相应的 API 文档。飞书提供的全部开放能力参考[API 列表](https://open.feishu.cn/document/ukTMukTMukTM/uYTM5UjL2ETO14iNxkTN/server-api-list)。

# 获取访问凭证

为了提升 API 调用的安全性，飞书开放平台设计了访问凭证（access_token）机制，调用 API 获取应用资源时，需要通过 access_token 对调用者身份进行鉴权，即告知飞书当前是谁、以什么身份获取什么租户的数据。

访问凭证是接入飞书开放平台的钥匙，将应用获得的所有数据访问和接口调用权限绑定在一起，允许应用对资源进行读写操作。建议开发者在正式开发前对飞书的访问凭证机制有充分的了解。

## 访问凭证介绍

飞书开放平台提供以下不同类型的访问凭证，用于对调用方身份进行鉴权。在实际开发过程中，你可以根据业务需要选择适用的访问凭证。

| 访问凭证类型        | 是否需要用户授权 | 说明                                                         |
| ------------------- | ---------------- | ------------------------------------------------------------ |
| tenant_access_token | 否               | 以应用身份调用 API 时需要使用的凭证，可读写的数据范围由应用的[数据权限范围](https://open.feishu.cn/document/home/introduction-to-scope-and-authorization/configure-app-data-permissions)决定。该访问凭证适用于无需用户登录的自动化操作，例如应用机器人调用[发送消息](https://open.feishu.cn/document/uAjLw4CM/ukTMukTMukTM/reference/im-v1/message/create)接口，向指定会话推送消息通知。<br>该类凭证的值以`t-`为前缀，示例值：`t-24b5bf4e00b2af1234`。 |
| user_access_token   | 是               | 以用户身份调用 API 时需要使用的凭证，可读写的数据范围由用户可读写的数据范围决定。该访问凭证适用于用户授权登录后代理用户的操作，例如，以 user_access_token 调用[创建多维表格](https://open.feishu.cn/document/uAjLw4CM/ukTMukTMukTM/reference/bitable-v1/app/create)接口，创建出来的多维表格的所有者是 user_access_token 对应的用户。<br>- 使用新版本接口（[获取 user_access_token](https://open.feishu.cn/document/uAjLw4CM/ukTMukTMukTM/authentication-management/access-token/get-user-access-token)、[刷新 user_access_token](https://open.feishu.cn/document/uAjLw4CM/ukTMukTMukTM/authentication-management/access-token/refresh-user-access-token)）返回的 user_access_token 示例值为 `eyJhbGciOiJFUzI1NiIs**********X6wrZHYKDxJkWwhdkrYg`<br>- 其他历史版本接口返回的凭证值以`u-`为前缀，示例值为 `u-Lr1RT7S8fS03mT1234`。 |
| app_access_token    | 否               | 应用身份的短期令牌。开放平台根据 app_access_token 识别调用方的应用身份。<br>该类凭证的值以`a-`或者`t-`为前缀，示例值：`a-24b5cef00b1234`。 |

## 如何选择不同类型的访问凭证
API 可能支持一种或多种访问凭证，不同的访问凭证代表不同的资源访问权限，因此，使用不同的访问凭证获取到的数据信息可能不同。

1. 确认 API 支持的访问凭证。

在调用 API 时，访问凭证需要填充到 HTTP 请求头中。在开放平台 API 文档的请求头部分，可查阅该 API 支持的访问凭证类型。

![](//sf3-cn.feishucdn.com/obj/open-platform-opendoc/2db90057e6c394fef306a80f30c84251_VqgPRnOcnF.png?height=318&lazyload=true&maxWidth=600&width=928)

2. 选择合适的访问凭证。warning
由于`app_access_token`的使用场景比较少（一般用于 [商店应用获取 tenant_access_token](https://open.feishu.cn/document/ukTMukTMukTM/ukDNz4SO0MjL5QzM/auth-v3/auth/tenant_access_token)），飞书开放平台正在逐步统一`app_access_token`和`tenant_access_token`两个凭证。因此这里主要介绍`tenant_access_token`和`user_access_token`。

- tenant_access_token

如果你的业务逻辑不需要操作用户的数据资源，仅需操作应用自身拥有的资源，例如在应用自身的文档目录空间下创建云文档，则推荐使用 tenant_access_token，无需额外申请授权。

- user_access_token

如果你的业务逻辑需要操作用户的数据资源，例如需要在用户的文档目录空间下创建云文档，则推荐使用 user_access_token，无需额外申请授权。

该情况下如果使用 tenant_access_token，则需额外在资源层面为应用添加相应的授权。例如，如果使用 tenant_access_token 调用通讯录，则需在飞书开发者后台的权限管理页面配置应用的通讯录权限范围；而使用 user_access_token 则无需单独配置通讯录权限范围，遵循 user_access_token 所属用户的通讯录权限范围。

## 获取方式

本章节介绍企业自建应用、商店应用如何获取相应的 access_token。
访问凭证存在有效期（在调用获取访问凭证接口后，会返回有效期字段）。开发者需要在自己的服务端设置定时刷新凭证的业务逻辑，以防止过期。如果在当前凭证过期前重新获取凭证，则会拿到与原值相同的值，但每次返回的剩余有效时间会发生变化，如下图所示。

![](//sf3-cn.feishucdn.com/obj/open-platform-opendoc/dba69fbde5e00970fdb60fdcba34bcc5_Q09daiPiIg.png?height=650&lazyload=true&maxWidth=600&width=2624)

### 获取自建应用的 tenant_access_token

1. 登录[开发者后台](https://open.feishu.cn/app/)，选择指定的自建应用。

2. 在 **基础信息** > **凭证与基础信息** 页面，获取应用凭证 **App ID** 和 **App Secret**。

![](//sf3-cn.feishucdn.com/obj/open-platform-opendoc/dea746f60b87470418f560b0bf4b3d20_yqW2dd4uel.png?height=794&lazyload=true&maxWidth=600&width=2882)

3. 调用[自建应用获取 tenant_access_token](https://open.feishu.cn/document/ukTMukTMukTM/ukDNz4SO0MjL5QzM/auth-v3/auth/tenant_access_token_internal) 接口，通过应用凭证 App ID 和 App Secret 获取自建应用的`tenant_access_token`。

### 获取自建应用的 app_access_token

1. 登录[开发者后台](https://open.feishu.cn/app/)，选择指定的自建应用。

2. 在 **基础信息** > **凭证与基础信息** 页面，获取应用凭证 **App ID** 和 **App Secret**。

![](//sf3-cn.feishucdn.com/obj/open-platform-opendoc/dea746f60b87470418f560b0bf4b3d20_YI1dAdC05z.png?height=794&lazyload=true&maxWidth=600&width=2882)

3. 调用[自建应用获取 app_access_token](https://open.feishu.cn/document/ukTMukTMukTM/ukDNz4SO0MjL5QzM/auth-v3/auth/app_access_token_internal) 接口，通过应用凭证 App ID 和 App Secret 获取自建应用的`app_access_token`。

### 获取商店应用的 app_access_token

1. 获取 app_ticket。

1. 为商店应用配置事件订阅请求地址。

具体操作参见[配置请求地址](https://open.feishu.cn/document/ukTMukTMukTM/uYDNxYjL2QTM24iN0EjN/event-subscription-configure-/request-url-configuration-case)。完成配置后，飞书会每隔 1 小时向该地址自动推送最新的 `app_ticket`，应用根据接收到的 [app_ticket 事件](https://open.feishu.cn/document/uAjLw4CM/ukTMukTMukTM/application-v6/event/app_ticket-events)来获取并保存`app_ticket`，以便后续使用。

2. （可选）调用[重新获取 app_ticket](https://open.feishu.cn/document/ukTMukTMukTM/ukDNz4SO0MjL5QzM/auth-v3/auth/app_ticket_resend) 接口，触发飞书重新推送 `app_ticket`。

`app_ticket` 推送可能存在延迟，如果没有收到推送，可以使用该方式重新推送 `app_ticket`。

2. 获取应用凭证 App ID 和 App Secret。

1. 登录[开发者后台](https://open.feishu.cn/app/)，选择指定的自建应用。

2. 在 **基础信息** > **凭证与基础信息** 页面，获取应用凭证 **App ID** 和 **App Secret**。

![](//sf3-cn.feishucdn.com/obj/open-platform-opendoc/dea746f60b87470418f560b0bf4b3d20_ASWIOnu6vY.png?height=794&lazyload=true&maxWidth=600&width=2882)

3. 调用[商店应用获取 app_access_token](https://open.feishu.cn/document/ukTMukTMukTM/ukDNz4SO0MjL5QzM/auth-v3/auth/app_access_token) 接口，通过应用凭证 App ID 和 App Secret、以及 app_ticket 获取商店应用的`app_access_token`。

### 获取商店应用的 tenant_access_token
请先获取并保存商店应用的 app_access_token，再获取商店应用的 tenant_access_token。

1. 获取 tenant_key。

`tenant_key`为租户在飞书上的唯一标识，用来换取对应的 `tenant_access_token`，也可以用作租户在应用里面的唯一标识，可以通过如下方式获取：

- 企业开通应用时，开放平台推送给应用的`tenant_key`数据，具体可参考[首次启用应用](https://open.feishu.cn/document/uAjLw4CM/ukTMukTMukTM/application-v6/event/app-first-enabled)。

- 用户登录到小程序、H5 应用或者浏览器应用时，在用户的身份信息中获取。

2. 调用[商店应用获取 tenant_access_token](https://open.feishu.cn/document/ukTMukTMukTM/ukDNz4SO0MjL5QzM/auth-v3/auth/tenant_access_token) 接口，通过`app_access_token`和`tenant_key`获取商店应用的`tenant_access_token`。

### 获取 user_access_token

本章节以应用的网页应用功能为例介绍如何获取 user_access_token。
获取 user_access_token 的方式同时适用于企业自建应用和商店应用。

1. 登录[开发者后台](https://open.feishu.cn/app/)，选择指定应用。

2. 在 **开发配置** > **安全设置** 页面，配置重定向 URL。

你需要将实际发起 API 请求的服务端公网地址配置为应用的重定向 URL。重定向 URL 支持配置多个，只有在重定向 URL 列表中的 URL 在请求时才会通过开放平台的安全校验。

![](//sf3-cn.feishucdn.com/obj/open-platform-opendoc/44dd68956f10ed76a926195d950ad6d1_vjdk5oRFFF.png?height=860&lazyload=true&maxWidth=600&width=2882)

3. 调用[获取授权登录授权码](https://open.feishu.cn/document/common-capabilities/sso/api/obtain-oauth-code)接口，获取登录预授权码 `code`。

调用接口时需要使用应用凭证 App ID，你可以在应用详情页的 **基础信息** > **凭证与基础信息** 页面，获取应用凭证 **App ID**。

![](//sf3-cn.feishucdn.com/obj/open-platform-opendoc/c7416cac0c09f060a1c7bcd1f6f3e711_u768pvaI19.png?height=372&lazyload=true&maxWidth=600&width=2398)

4. 调用[获取 user_access_token](https://open.feishu.cn/document/uAjLw4CM/ukTMukTMukTM/authentication-management/access-token/get-user-access-token)接口，获取`user_access_token`。

同时可以获取到 Token 的有效期（expires_in 响应字段）。

5. （可选）调用[刷新 user_access_token](https://open.feishu.cn/document/uAjLw4CM/ukTMukTMukTM/authentication-management/access-token/refresh-user-access-token)接口，刷新 `user_access_token`。

`user_access_token` 的有效期为两小时左右，过期后，需要刷新后再使用。

## 如何使用访问凭证（access_token）

使用访问凭证（access_token），需要在调用接口时将其填入到 HTTP 请求的 **请求头参数** 中，且该值需要增加 `Bearer<空格>` 前缀。
为了安全考虑， 请勿在应用前端使用访问凭证。请在应用服务端发起 API 访问请求。

![](//sf3-cn.feishucdn.com/obj/open-platform-opendoc/b0f1b4fbe0b37ad50fd463cc62d6113a_xEF3kzfSBf.png?height=446&lazyload=true&maxWidth=600&width=2630)

每个 OpenAPI 文档中，均声明了该接口需要的访问凭证类型和获取方式。

![](//sf3-cn.feishucdn.com/obj/open-platform-opendoc/150a25756c38db441db1950b8a9c4f78_qIp37KxjhW.png?height=546&lazyload=true&maxWidth=600&width=2602)

例如，cURL 请求配置示例如下：
调用 API 的详细操作参见[调用 API](https://open.feishu.cn/document/ukTMukTMukTM/ukDNz4SO0MjL5QzM/get-)。

```Bash
curl --location --request GET 'https://open.feishu.cn/open-apis/contact/v3/departments/od-64242a18099d3a31acd24d8fce8dxxxx' \
--header 'Authorization: Bearer t-5888bcb7c421a695ca83c449caba5cxxxx' \
--header 'Content-Type: application/json; charset=utf-8'
```

# 申请 API 权限

通过本文你可以了解什么是应用的 API 权限，以及如何为应用申请 API 权限。

## 什么是 API 权限

在开发应用过程中，你可能需要调用[服务端 API](https://open.feishu.cn/document/ukTMukTMukTM/uYTM5UjL2ETO14iNxkTN/server-api-list)或监听已订阅的[事件](https://open.feishu.cn/document/ukTMukTMukTM/uYDNxYjL2QTM24iN0EjN/event-list)，该类操作可能涉及访问企业、用户的隐私信息，也可能需要操作企业、用户的应用数据。出于安全考虑，你需要为应用申请相应的权限，并且由企业管理员审核通过后，应用才可以进行后续的 API 调用或事件监听。简单来说，应用的 API 权限（Scope）决定了应用能使用哪些飞书服务端的开放能力。
**API 权限是以应用为维度授予的**，每个应用的 API 权限都是独立存在的，若多个应用需要调用同一个 API ，那么每个应用都要添加对应的 API 权限。

开放平台支持的所有权限，可参考[API 权限列表](https://open.feishu.cn/document/ukTMukTMukTM/uYTM5UjL2ETO14iNxkTN/scope-list)。

## 权限类型

为了提升 API 调用的安全性，飞书开放平台设计了访问凭证（access_token）机制，调用 API 获取应用资源时，需要通过 access_token 对调用者身份进行鉴权，即告知飞书当前是谁、以什么身份获取什么租户的数据。关于如何选择和获取不同类型 access token，参考 [获取访问凭证](https://open.feishu.cn/document/ukTMukTMukTM/uMTNz4yM1MjLzUzM)。

调用 API 时，以用户身份（user_access_token） 调用和 以应用身份（tenant_access_token）调用的权限敏感等级不同，涉及的风险程度不同，因此对应的审核要求也不同，开发者申请权限时需要区分用户身份、应用身份。

![](//sf3-cn.feishucdn.com/obj/open-platform-opendoc/042e96c35b824692e2cacdc8ec05492c_m1ISAc0t29.png?height=706&lazyload=true&maxWidth=600&width=1264)

为了更好地支持权限最小化原则，根据权限所归属的不同身份主体，开放平台将 API 权限划分为以下两种类型：

| 权限类型                         | 描述                                                         | 场景示例                                                     |
| -------------------------------- | ------------------------------------------------------------ | ------------------------------------------------------------ |
| 应用身份权限 tenant_access_token | 以 [tenant_access_token](https://open.feishu.cn/document/ukTMukTMukTM/uMTNz4yM1MjLzUzM#5aa2e490) 调用 API 或者订阅事件时，需要申请应用身份权限。 | 假设有一个应用名为 “My bot”，该应用：<br>- 调用[创建多维表格](https://open.feishu.cn/document/uAjLw4CM/ukTMukTMukTM/reference/bitable-v1/app/create)接口时，如果以 tenant_access_token 调用，则多维表格的所有者是 “My bot”。<br>- [订阅云文档变更事件](https://open.feishu.cn/document/uAjLw4CM/ukTMukTMukTM/reference/drive-v1/file/subscribe)时，如果以 tenant_access_token 订阅，则仅能订阅 “My bot” 作为拥有者或者管理员的文档变更，无法感知其他文档变更。 |
| 用户身份权限 user_access_token   | 以 [user_access_token](https://open.feishu.cn/document/ukTMukTMukTM/uMTNz4yM1MjLzUzM#5aa2e490) 调用 API 或者订阅事件时，需要申请用户身份权限。 | 假设有一个应用名为 “My bot”，该应用：<br>- 调用[创建多维表格](https://open.feishu.cn/document/uAjLw4CM/ukTMukTMukTM/reference/bitable-v1/app/create)接口时，如果以 user_access_token 调用，且该 token 代表用户 “李健”，则多维表格的所有者是 “李健”。<br>- [订阅云文档变更事件](https://open.feishu.cn/document/uAjLw4CM/ukTMukTMukTM/reference/drive-v1/file/subscribe)时，如果以 user_access_token 订阅，该 token 代表的用户是 “李健”，则仅能订阅 “李健” 作为拥有者或者管理员的文档变更，无法感知其他文档变更。 |

## 权限等级

在商店应用、自建应用两类不同的应用中，权限存在不同的等级划分。你可以通过下表了解不同应用类型中的权限等级划分情况。关于权限等级的划分原则及平台推荐的默认审核规则，参考[自建应用的权限介绍和审核规则推荐](https://www.feishu.cn/hc/zh-CN/articles/455824553396)。

### 自建应用

| 是否需要审核 | 权限说明                                                     | 权限审核规则                                                 |
| ------------ | ------------------------------------------------------------ | ------------------------------------------------------------ |
| 免审权限     | 企业管理员可以根据本企业实际数据管控诉求，配置免审权限来减轻审核负担。具体配置方法，可参见[管理员如何设置自建应用审核规则](https://www.feishu.cn/hc/zh-CN/articles/374230668270-%E8%87%AA%E5%BB%BA%E5%BA%94%E7%94%A8%E5%8F%91%E7%89%88%E5%AE%A1%E6%A0%B8%E6%8C%87%E5%8D%97)。 | 无需审核，申请后立即生效。                                   |
| 需审核权限   | 对于涉及敏感数据的权限，请纳入需审核权限列表。               | 申请后，需要创建版本并提交审核，由应用管理员审核通过后才可生效。 |

### 商店应用

| 权限等级 | 权限说明                                                     | 权限审核规则                                                 |
| -------- | ------------------------------------------------------------ | ------------------------------------------------------------ |
| 普通权限 | 访问的数据敏感程度不高。                                     | 对于商店应用，所有的权限操作都需要经过以下审核流程：<br>- 应用上架流程审核：由飞书开放平台审核。<br>- 租户安装应用流程审核：由租户管理员在版本更新时审核。 |
| 高级权限 | 访问的数据敏感程度较高。如无必要原因，申请高级权限时不会通过审核。 | 对于商店应用，所有的权限操作都需要经过以下审核流程：<br>- 应用上架流程审核：由飞书开放平台审核。<br>- 租户安装应用流程审核：由租户管理员在版本更新时审核。 |

### 权限申请原则

权限的申请应该遵循最小可用原则，权限范围过大可能会威胁企业数据安全管控。在无充分理由的情况下，请注意避免直接申请大量接口权限。因此，在飞书开放体系中，权限的管控有严格的审核流程。

- **企业自建应用**：应用开发者申请的权限需要通过 **租户管理员** 的审核。租户管理员可以按需配置审核规则和审核方式，参考[自建应用发版审核指南](https://www.feishu.cn/hc/zh-CN/articles/374230668270)。

![](//sf3-cn.feishucdn.com/obj/open-platform-opendoc/9d85c5a218aade1a90742badce398770_9o1byXFiAa.png?height=1758&lazyload=true&maxWidth=600&width=3070)

- **ISV 开发的商店应用**：如需申请权限，需要通过飞书开放平台[发布应用](https://open.feishu.cn/document/uMzNwEjLzcDMx4yM3ATM/uYjMyUjL2IjM14iNyITN)时和[租户安装应用](https://www.feishu.cn/hc/zh-CN/articles/360049067744)时的两道审核流程。

如下图所示，商店应用在初次安装和版本更新时会接收到授权提醒。租户管理员可以按需设置管理规则，参考[审核应用的获取与使用申请](https://www.feishu.cn/hc/zh-CN/articles/360025024813)。

![](//sf3-cn.feishucdn.com/obj/open-platform-opendoc/51b521b3cf74111b2133738801b79680_wIZhM6aFEi.png?height=1194&lazyload=true&maxWidth=600&width=1160)

### 确定所需申请的权限

当你在实际开发应用时，可根据 API 或事件的开发文档获取相应的权限信息。
以[获取单个用户信息](https://open.feishu.cn/document/uAjLw4CM/ukTMukTMukTM/reference/contact-v3/user/get)接口为例，在相应的接口文档中，你可以获取接口的权限要求、字段权限要求等信息。

![](//sf3-cn.feishucdn.com/obj/open-platform-opendoc/453a586c38b6944cb7d91fddc0a10ad1_ysx9lo2bsI.png?height=1278&lazyload=true&maxWidth=600&width=2882)

其中：

- **权限要求**：代表整个接口的权限要求，该类权限之间是**或**关系，即应用申请任一权限即可调用该接口。

- **字段权限要求**：展示了获取响应体字段数据所需的权限要求。

例如下图，自建应用想要获取响应体中的`user_id`字段值，则必须开通 **获取用户 user ID** 权限。

![](//sf3-cn.feishucdn.com/obj/open-platform-opendoc/4fa894ebd2d7b0e4498352a0aa3e14eb_w3nIqyjocR.png?height=1144&lazyload=true&maxWidth=600&width=2882)

## 为企业自建应用申请 API 权限

### 步骤一：申请权限

1. 登录[开发者后台](https://open.feishu.cn/app)，进入指定自建应用。

2. 在左侧导航栏进入 **开发配置** > **权限管理** 页，点击 **开通权限** 按钮。

3. 在弹出页面中选择所需权限，点击 **确认开通权限**，系统自动跳转到已申请的权限列表页面。
    -   注意在不同的页签下进行不同类型权限的申请。
    - 如需使用应用身份凭证（tenant_access_token） 进行调用相关 API，还需为应用配置可访问的数据范围，参考 [配置应用数据权限](https://open.feishu.cn/document/home/introduction-to-scope-and-authorization/configure-app-data-permissions)。
    - 以用户身份 **（** user_access_token）调用时，可读写的数据范围与用户本人可读写的数据范围一致，无需单独配置数据权限。    

![image.png](//sf3-cn.feishucdn.com/obj/open-platform-opendoc/1be778312abd0eda4432abce4a84506a_RoB2cpzL9M.png?height=1608&lazyload=true&maxWidth=600&width=2952)

4. 选择完成后，在 **权限配置** 区域右上角点击 **批量开通**。

### 步骤二：免审核 API 权限进行测试联调

在应用的测试联调阶段，你可以通过以下路径，无需审核通过即可生效 **需审核权限**，进行 API 调试。

![image.png](//sf3-cn.feishucdn.com/obj/open-platform-opendoc/228fbc7131418c94b8834f06d7d99bfb_Ui29UmQ64w.png?height=710&lazyload=true&maxWidth=600&width=3448)

#### 方式一：使用 user_access_token 调试 API

批量申请 API 权限时，如果权限支持通过应用开发者的 user_access_token 免审调用 API ，则在申请权限后，无需发布应用即可使用 user_access_token 调试 API。

以调用[列出自定义角色](https://open.feishu.cn/document/uAjLw4CM/ukTMukTMukTM/reference/bitable-v1/app-role/list)接口为例，在调用前需要在应用的 **API 权限** 功能页中，申请 **查看、评论、编辑和管理多维表格** 或者 **查看、评论和导出多维表格** 权限。

![](//sf3-cn.feishucdn.com/obj/open-platform-opendoc/840b669519a56fe7a257e316950a1aa6_QJCXMGtl4x.png?height=1540&lazyload=true&maxWidth=600&width=1784)

申请后，无需发布应用并等待审核通过，直接使用应用开发者的用户访问凭证（user_access_token）即可调试 API。

![](//sf3-cn.feishucdn.com/obj/open-platform-opendoc/165f62a04e928e62ec40d98267bb6ec9_R14zcVp0Vi.png?height=1200&lazyload=true&maxWidth=600&width=2260)

#### 方式二：使用测试企业调试 API

在 API 权限中，存在不支持 user_access_token 鉴权的 API，且支持 user_access_token 鉴权的 API 中也存在少量的敏感权限基于 user_access_token 无法免审调试 API。该类权限在申请时可以通过提示查看（如下图所示）。

![](//sf3-cn.feishucdn.com/obj/open-platform-opendoc/335040a642427abf10af0234ed138d8a_JokZqcJMPS.png?height=420&lazyload=true&maxWidth=600&width=2254)

此时，你可以为应用配置测试企业和人员，并切换为测试版本（具体操作参见[测试企业与人员](https://open.feishu.cn/document/home/introduction-to-custom-app-development/testing-enterprise-and-personnel-functions)）。切换后，前往 **开发配置** > **权限管理** 页面，在 **API 权限** 页签申请指定权限，申请的权限均为 **免审权限**，点击 **确认** 后立即生效。
如果你申请了 **通讯录** 或者 **飞书人事（企业版）** API 权限，且需要通过应用身份（tenant_access_token）调用相关 API，则需要为应用配置相应的数据权限。详情参见[配置应用数据权限](https://open.feishu.cn/document/home/introduction-to-scope-and-authorization/configure-app-data-permissions)。

![image.png](//sf3-cn.feishucdn.com/obj/open-platform-opendoc/3c5d744adabdebe6ff843098cca3848b_Hx6u7N6C5u.png?height=630&lazyload=true&maxWidth=600&width=1782)

### 步骤三：正式发布应用

确保测试联调阶段申请的权限符合预期后，你可以提交应用的正式版本发布申请。

1. 在 **应用发布** > **版本管理与发布** 页面，点击 **创建版本**。
使用测试企业调试 API 的场景中，开通的权限不会生效于应用的正式版本。因此在完成测试联调后，需要切换至正式版本的应用，为正式版应用再次开通相同的 API 权限。你可以使用**批量导入导出**功能，进行应用间的权限数据迁移。

2. 在 **版本详情** 页面，配置以下字段，并点击 **保存**。

![](//sf3-cn.feishucdn.com/obj/open-platform-opendoc/8a5ebea29e28f422bf6b55817818c5d8_K2PcyliptA.png?height=1428&lazyload=true&maxWidth=600&width=2330)

- **应用版本号**：自定义应用版本号，格式示例：1.0.0。

- **更新说明**：自定义当前版本的更新详情。

- **应用能力**、**权限变更**：查看并确认添加的能力、权限是否符合预期。

- **可用范围**：应用的可用范围。可点击 **编辑**，调整可用范围。关于可用范围的说明可参见[配置应用可用范围](https://open.feishu.cn/document/home/introduction-to-scope-and-authorization/availability)。

- **申请理由**：用于帮助审核人员了解更多应用版本信息。

3. 在弹出的对话框中，点击 **申请线上发布**。

![](//sf3-cn.feishucdn.com/obj/open-platform-opendoc/00b0bf496c7efacb3489bcd6ed9fbde0_J1kqDXBWlJ.png?height=826&lazyload=true&maxWidth=600&width=2324)

4. 等待企业管理员审核应用。

当应用通过审核后，所有的 API 权限才会正式生效。

![](//sf3-cn.feishucdn.com/obj/open-platform-opendoc/e74676dbe3ca25d8636205473f021bcd_sRRr2gmfOK.png?height=660&lazyload=true&maxWidth=600&width=2348)

## 为商店应用申请 API 权限

### 步骤一：申请权限

1. 在[开发者后台](https://open.feishu.cn/app)进入指定商店应用。

2. 在左侧导航栏进入 **开发配置**  > **权限管理** 页，点击 **开通权限**。

![image.png](//sf3-cn.feishucdn.com/obj/open-platform-opendoc/372800a2c7cb3ab804e916757a689111_qM7GUvVMN7.png?height=1274&lazyload=true&maxWidth=600&width=2640)

4. 选择所需的权限后，点击 **确认开通权限**，系统自动跳转到已申请（待发布）的权限列表页面。

![image.png](//sf3-cn.feishucdn.com/obj/open-platform-opendoc/5b786250e4525ed1b50ee1dda86e9030_hvS2V4iReA.png?height=1210&lazyload=true&maxWidth=600&width=1280)

### 步骤二：免审核 API 权限进行测试联调

在应用的测试联调阶段，你可以通过商店应用的测试企业和人员功能，生成测试版本。基于测试版本开通的权限无需等待审核通过即可生效，从而进行 API 调试。

1. 在左侧导航栏，选择 **开发配置** > **测试企业和人员**，然后创建一个测试企业。
关于测试商店应用的详细配置，参见[六、测试商店应用](https://open.feishu.cn/document/uMzNwEjLzcDMx4yM3ATM/uUjMyUjL1IjM14SNyITN)。

![](//sf3-cn.feishucdn.com/obj/open-platform-opendoc/015de7c6fa84c0cd94f696828c9b193e_3ilff2hvzh.png?height=802&lazyload=true&maxWidth=600&width=2882)

2. 在左侧导航栏，选择 **应用发布** > **版本管理与发布**，然后点击 **创建版本**。

![](//sf3-cn.feishucdn.com/obj/open-platform-opendoc/fd5029fe46110102cad4ed56a6a29602_hPJJcQYHg7.png?height=840&lazyload=true&maxWidth=600&width=2882)

3. 依次配置版本号、版本说明，并确认待开通权限的完整性，最后在页面底部点击 **保存**。

![](//sf3-cn.feishucdn.com/obj/open-platform-opendoc/d34c4d4f8ac284359d8381756e1644db_k58likMeVE.png?height=1318&lazyload=true&maxWidth=600&width=2882)

4. 在 **待申请** 版本页面，点击 **设置为测试版本**，并在弹出的对话框完成测试版本的设置。

![](//sf3-cn.feishucdn.com/obj/open-platform-opendoc/f2541dc1c7eb5ed01495d9ccdc099198_3IPlxQO467.png?height=974&lazyload=true&maxWidth=600&width=2326)

完成配置后，版本状态会变更为 **测试中**，此时该应用已安装到对应测试企业，并可以在该测试企业中免审调用 API。

![](//sf3-cn.feishucdn.com/obj/open-platform-opendoc/ff9d0637fef0aeaeeaefce0fdccc86f9_6lE3TXTciM.png?height=396&lazyload=true&maxWidth=600&width=2224)

### 步骤三：正式发布应用

确保测试联调阶段申请的权限符合业务预期后，前往 **应用发布** > **版本管理与发布** 页面，发布应用。
商店应用的正式发布分为定向上架、全量上架、非公开上架。你需要根据业务实际情况选择发布，详细介绍参见[七、发布商店应用](https://open.feishu.cn/document/uMzNwEjLzcDMx4yM3ATM/uYjMyUjL2IjM14iNyITN)。

## 批量导入导出 API 权限

为了便于开发者进行跨应用的权限数据迁移，开放平台提供了批量导入导出 API 权限的能力。你可以在[开发者后台](https://open.feishu.cn/app)的 **权限管理** 页面进行权限的批量导入、导出。
批量导入导出权限支持企业自建应用和商店应用。

![](//sf3-cn.feishucdn.com/obj/open-platform-opendoc/27abd7201893bcba470a52b6af1f1fe4_0mR5buGag1.png?height=842&lazyload=true&maxWidth=600&width=2088)

## 批量导入权限

导入的权限将 **作为此次新增申请的权限，不会影响已申请或开通的权限**。
你可以按照以下示例格式录入所需权限，也可以一键恢复默认值或对输入内容进行格式化 JSON。
录入权限时，系统会实时校验该权限是否存在，如果不存在或该应用不在该权限的可用范围内，则会收到错误提示：该权限不存在或该应用无权申请该权限，请重新录入。

![](//sf3-cn.feishucdn.com/obj/open-platform-opendoc/a82210ab38d543fcd0c109dce3cdd5dc_pryVYedkX2.png?height=1016&lazyload=true&maxWidth=600&width=1592)

确认导入权限清单无误后，点击**申请开通**。
- 请注意检查不同身份类型页下的权限点。系统会根据应用身份权限、用户身份权限两种类型分别展示导入的权限清单，若此次导入权限不涉及某个身份类型，则不会展示该类型页签。
- 系统会自动过滤已申请权限，避免重复申请。

![](//sf3-cn.feishucdn.com/obj/open-platform-opendoc/8c23c93531c6e2f579936afb9ad13203_MJjWu0dx6g.png?height=814&lazyload=true&maxWidth=600&width=1582)

申请开通后，系统自动跳转到权限管理页面：

- 若导入的权限属于自建应用的免审权限，或导入的应用为测试版本应用，则权限状态变为已开通。
- 若导入的权限关联了数据范围，则需要为该权限 [配置数据范围](https://open.feishu.cn/document/home/introduction-to-scope-and-authorization/configure-app-data-permissions)。
- 若导入的权限需要审核，即权限状态为待发布，在确认权限配置无误后，你需要[提交版本发布](https://open.feishu.cn/document/ukTMukTMukTM/uQjN3QjL0YzN04CN2cDN#563a5dbd)申请，由企业管理员审核通过后才会生效。

![](//sf3-cn.feishucdn.com/obj/open-platform-opendoc/f1b4059b47a3a6b1da3390f959410eaf_zjzjlZ6eH6.png?height=920&lazyload=true&maxWidth=600&width=2272)

## 批量导出权限

在权限的**导出**页签中，你可以一键复制当前应用已申请的全部权限（包括 **待发布、审核中、已开通** 状态），用于后续将权限数据一键导入至其他应用。

![](//sf3-cn.feishucdn.com/obj/open-platform-opendoc/2e9bd407db8446eff4f120cc048c0427_bfRgOKu0AC.png?height=1502&lazyload=true&maxWidth=600&width=1574)

# 调用 API

为了让开发者可以便捷地调用 API，飞书开放平台提供了 Java SDK、Go SDK、Python SDK 和 Node SDK。有关 SDK 的详细介绍，可以参考[服务端 SDK](https://open.feishu.cn/document/ukTMukTMukTM/uETO1YjLxkTN24SM5UjN)。本文介绍基本的 API 调用方法。

## 前提条件

- 完成创建应用、[申请权限](https://open.feishu.cn/document/ukTMukTMukTM/uQjN3QjL0YzN04CN2cDN)、[获取访问凭证](https://open.feishu.cn/document/ukTMukTMukTM/uMTNz4yM1MjLzUzM)、[设置 IP 白名单](https://open.feishu.cn/document/ukTMukTMukTM/ucTMxYjL3ETM24yNxEjN)之后，才能调用服务端 API。
- 调用 API 时，需要将访问凭证放入请求 Header 中（`Authorization:Bearer <access token>`）。
- 调用服务端 API 时，需要使用 HTTPS 协议、UTF-8 编码。

## 调用示例

### 向企业内员工发消息

你可以调用[发送消息](https://open.feishu.cn/document/uAjLw4CM/ukTMukTMukTM/reference/im-v1/message/create)接口完成向企业内员工发消息的操作，从接口文档中可以确定，调用该接口前，需要获取 `tenant_access_token`。

1.  参考 [获取访问凭证](https://open.feishu.cn/document/ukTMukTMukTM/uMTNz4yM1MjLzUzM) 获取 `tenant_access_token`。

获取凭证的请求示例如下，你需要将 *app_id* 和 *app_secret* 替换为实际值。

```bash
    curl -X POST 'https://open.feishu.cn/open-apis/auth/v3/tenant_access_token/internal/'
    -H 'Content-Type: application/json; charset=utf-8' 
    -d '{
    "app_id": "<app_id>",
    "app_secret": "<app_secret>"
	}'
```

2. 根据文档内的请求参数描述，调用[发送消息](https://open.feishu.cn/document/uAjLw4CM/ukTMukTMukTM/reference/im-v1/message/create)接口。

- 方式一：在调试台发起 API 调用

![image.png](//sf3-cn.feishucdn.com/obj/open-platform-opendoc/aa007bc867dc38d935cdcd335a037c06_smkGlGqsxN.png?height=332&lazyload=true&maxWidth=600&width=943)
	- 方式二：本地发送 curl 请求

该 API 需要使用 POST 方式发起。

![image.png](//sf3-cn.feishucdn.com/obj/open-platform-opendoc/85be6f7b4a4611d41665b1120c1b1445_0TGCvluM2T.png?height=366&lazyload=true&maxWidth=600&width=730)

示例如下，请将参数示例值替换为实际值。

```bash
		curl -X POST 'https://open.feishu.cn/open-apis/im/v1/messages?receive_id_type=user_id'
		-H 'Authorization:Bearer <tenant_access_token>'
		-H 'content-type:application/json; charset=utf-8'
		-d '{
	        	"content": {
	                	"text": "Hello World"
	        	},
	        	"msg_type": "text",
 	       	"receive_id": "<user_id>"
		}'
```

- *receive_id_type* 作为查询参数。
		- *content* *、msg_type* 和 *receive_id* 作为请求的 Body 内容。
		- 请求所需的 `tenant_access_token` 和 Content-Type 放在 Header 中。

### 查询用户信息

你可以调用[获取单个用户信息](https://open.feishu.cn/document/uAjLw4CM/ukTMukTMukTM/reference/contact-v3/user/get)接口查询用户信息。从接口文档中可以确定，调用该接口前，需要获取 `tenant_access_token` 或 `user_access_token`，请根据需要获取的用户信息范围，选择合适的访问凭证。

1. 参考 [获取访问凭证](https://open.feishu.cn/document/ukTMukTMukTM/uMTNz4yM1MjLzUzM) 获取 `tenant_access_token` 或 `user_access_token`。

2. 根据文档内的请求参数描述，调用[获取单个用户信息](https://open.feishu.cn/document/uAjLw4CM/ukTMukTMukTM/reference/contact-v3/user/get)接口。

- 方式一：在调试台发起 API 调用

![](//sf3-cn.feishucdn.com/obj/open-platform-opendoc/60edbe9c112de55e65427818eab3fa06_DE7dVr6hYb.png?height=151&lazyload=true&maxWidth=350&width=437)

- 方式二：本地发送 curl 请求

从接口文档中可以看出，`user_id` 是该接口的路径参数，例如我们查询一个 `user_id` 为 `ou_c99c5f35d542efc7ee492afe11af19ef` 的用户信息，示例如下：

```bash
        curl -X GET 'https://open.feishu.cn/open-apis/contact/v3/users/ou_c99c5f35d542efc7ee492afe11af19ef?user_id_type=user_id' \
        -H 'Authorization: Bearer <tenant_access_token>' \
        -H 'Content-Type: application/json; charset=utf-8'
```

## 响应结果

绝大多数 API 的响应体结构包括 `code`、`msg`、`data` 三个部分：
- `code`：错误码。如果是成功响应，`code` 取值为 0。
- `msg` ：错误信息。
- `data`：API 的调用结果。`data` 在一些操作类 API 的返回中可能不存在。
- 请不要依据 `msg` 来判定一个请求是否失败。
- 接收到失败响应后，你可以先查看 [通用错误码](https://open.feishu.cn/document/ukTMukTMukTM/ugjM14COyUjL4ITN)说明，排查问题。如果依然不能解决问题，可以向飞书开放平台反馈响应头中的 `x-tt-logid` 值，以便我们协助定位问题。

成功响应示例：
```json
{
  "code": 0,
  "msg": "success",
  "data": {
    // 响应的具体数据内容
  }
}
```
失败响应示例：
```json
{
  "code": 40004,
  "msg": "no dept authority error"
}
```

## 错误响应说明

飞书开放平台 OpenAPI 错误信息模块包含 HTTP 状态码、业务状态码（code）、错误信息（msg）、错误排查信息（error）四个大类。 warning
由于在接口迭代的过程中，错误信息（msg）可能会随时发生变化，因此开发者需要避免在代码逻辑里依赖 msg，建议根据返回的业务状态码（code）判断一个请求是否失败。

错误响应结构如下所示：

```json 
HTTP / 1.1 400 Bad Request // HTTP 状态码
{
    "code": 44004,
    // 业务状态码
    "msg": "{error msg}, {help}, {url}.",
    // 错误信息
    "error": {
        "message": "Refer to the documentation to fix the error: https://open.feishu.cn/document/uAjLw4CM/ugTN1YjL4UTN24CO1UjN/trouble-shooting/how-to-obtain-openid",
        "field_violations": [
            {
                "field": "para_a",
                "value": "testvalue_a",
                "description": "test description_a"
            }
        ],
        "permission_violations": [
            {
                "scope": "lark.im.xxx",
                "url": "https://open.feishu.cn/apps/cli_xxxx/auth"
            }
        ],
        "helps": [
            {
                "url": "https://open.feishu.cn/app/cli_a61e4f821889d00c/auth?q=event:ip_list&op_from=openapi",
                "description": "Learn more about scopes and how to add them: [event:ip_list]"
            }
        ],
        "logid": "xxx",
        "troubleshooter": "排查建议查看（Troubleshooting suggestions）：https://open.feishu.cn/search?from=openapi&log_id=XXXX&code=XXX&method_id=XXX"
    }
}
```

| 错误信息模块          | 描述                                                         |
| --------------------- | ------------------------------------------------------------ |
| HTTP 状态码           | 用于进行错误分类，如客户端错误（4XX）、服务端错误（5XX）。   |
| 业务状态码 (code)     | 代表具体的错误场景，如参数错误、鉴权错误。业务失败情况下，返回非 0 业务状态码，且 HTTP 状态码为 400 或 500 系列。 |
| 错误信息 (msg)        | 错误码 code 关联的具体错误描述。**msg** 可能会优化和调整，因此不要依赖 **msg** 进行代码判断，建议依赖 **code** 进行请求失败的代码判断。 |
| 错误排查信息 (error)  | 说明具体是哪个部分出现了问题，帮助开发者定位错误的原因，并提供建议的解决方案。 |
| message               | 提供当前错误场景的更多帮助信息，如错误参数内容。             |
| troubleshooter        | 该字段的值是一个链接，可以直接复制后用浏览器打开，页面中会给出错误原因分析和对应的解决方案。<br>如果你是在独立的 API 调试台或 API 文档内嵌的调试台中进行调试调用，可以直接在下方获取智能助手的详细排查建议。 |
| logid                 | API 调用日志 ID，可以通过在开放平台官网上搜索 logid 字段，获取详细的错误原因和排查建议。<br>你也可以登录[开发者后台](https://open.feishu.cn/app)并进入调用 API 的应用的详情页，在 **日志检索** > **服务端日志检索** 功能页过滤出对应的 API 调用日志数据。 |
| field_violations      | 代表参数错误，当请求不满足参数数据校验规则时，返回的错误信息会包含该参数。例如，某 int 类型请求参数要求传值在 1~10 之间，实际请求时传入了 11 则会报错并返回 field_violations。你的服务可依赖该参数进行代码处理。field_violation 为数组，数组内结构为 Object。结构示例如下：<br>```json<br>{<br>"field_violations": [<br>{<br>"field": "para_a",<br>"value": "testvalue_a",<br>"description": "test description_a"<br>}<br>]<br>}<br>``` |
| field                 | 具体的错误参数                                               |
| value                 | 错误参数的取值                                               |
| description           | 字段错误的描述                                               |
| permission_violations | 代表权限错误，请求时如果应用开通的权限不满足 API 需要会报错并返回该参数。你的服务可依赖该参数进行代码处理。permission_violation 为数组，数组内结构为 Object。结构示例如下：<br>```json<br>{<br>"permission_violations": [<br>{<br>"scope": "lark.im.xxx",<br>"url": "https://open.feishu.cn/apps/cli_xxxx/auth"<br>}<br>]<br>}<br>``` |
| scope                 | 需要开通的权限。                                             |
| url                   | 对应的添加权限的地址。可以点击后直接前往开发者后台权限页面进行申请开通。 |
| helps                 | 权限不足时返回该参数，你可以访问 URL 快速跳转到缺失权限的应用 API 权限页面开通权限。结构示例如下：<br>```json  <br>{<br>"helps": [<br>{<br>"url": "https://open.feishu.cn/app/cli_a61e4f1234xxx/auth?q=event:ip_list&op_from=openapi",<br>"description": "Learn more about scopes and how to add them: [event:ip_list]"<br>}<br>]<br>}<br>``` |
| url                   | 对应的添加权限的地址。可以点击后直接前往开发者后台权限页面进行申请开通。 |
| description           | 提供缺失的权限信息。                                         |

## 相关教程

你也可参考以下教程快速体验如何调用服务端 API：
- [快速调用一个服务端 API（以发送
消息接口为例）](https://open.feishu.cn/document/uAjLw4CM/uMzNwEjLzcDMx4yM3ATM/how-to-call-a-server-side-api/introduction)
- [快速调用一个服务端 API（以创建多维表格为例）](https://open.feishu.cn/document/uAjLw4CM/uMzNwEjLzcDMx4yM3ATM/call-a-server-api-base-example/introduction)

# 获取授权码

本接口用于发起用户授权，应用在用户同意授权后将获得授权码 `code`。请注意授权码的有效期为 5 分钟，且只能被使用一次。

## 注意事项

- 本接口实际为授权页面，适用于网页应用的授权场景。在需要用户授权时，应用应将用户重定向至本授权页面。当用户在授权页面点击授权后（在飞书客户端内打开网页应用时可免确认直接跳转），浏览器将跳转至 `redirect_uri` 所指定的地址，并携带 `code` 查询参数（即授权码）。

- 开发者可通过授权码获取 `user_access_token`，以调用 OpenAPI（例如[获取用户信息](https://open.feishu.cn/document/uAjLw4CM/ukTMukTMukTM/reference/authen-v1/user_info/get)）。有关获取 `user_access_token` 的详细步骤，可参考[获取 user_access_token](https://open.feishu.cn/document/uAjLw4CM/ukTMukTMukTM/authentication-management/access-token/get-user-access-token)。
- 通过本接口配合[获取 user_access_token](https://open.feishu.cn/document/uAjLw4CM/ukTMukTMukTM/authentication-management/access-token/get-user-access-token)以及[获取用户信息](https://open.feishu.cn/document/uAjLw4CM/ukTMukTMukTM/reference/authen-v1/user_info/get)，应用可实现飞书授权登录。
- 完整的用户授权链路实现，可参考[浏览器应用接入指南](https://open.feishu.cn/document/common-capabilities/sso/web-application-end-user-consent/guide)。
- 在打开授权页面时，需要通过拼接 `scope` 查询参数声明应用所需的用户授权权限。例如，获取通讯录基本信息的权限对应的 `scope` 键为 `contact:contact.base:readonly`。  
- 用户授予应用的权限是累积的，最新生成的 `user_access_token` 将包含用户历史上已授予的所有权限。  
- 当应用使用 `user_access_token` 调用某个 OpenAPI 时，必须确保该 `user_access_token` 具备[目标 OpenAPI 所需的权限](https://open.feishu.cn/document/ukTMukTMukTM/uQjN3QjL0YzN04CN2cDN)，否则调用将失败。

## 请求

| 基本                                                         | &nbsp;                                                   |
| ------------------------------------------------------------ | -------------------------------------------------------- |
| HTTP URL                                                     | https://accounts.feishu.cn/open-apis/authen/v1/authorize |
| HTTP Method                                                  | GET                                                      |
| 接口频率限制                                                 | 1000 次/分钟、50 次/秒                                   |
| 支持的应用类型                                               | Custom App、Store App                                    |
| 权限要求<br>**调用该 API 所需的权限。开启其中任意一项权限即可调用** | 无                                                       |

### 查询参数

>  为了确保 URL 构造 & 编码正确，建议使用相关的 URL 标准库来完成 URL 的解析和构建，避免手动拼接。

| 名称                  | 类型   | 必填 | 描述                                                         |
| --------------------- | ------ | ---- | ------------------------------------------------------------ |
| client_id             | string | 是   | 应用的 App ID，可以在开发者后台的**凭证与基础信息**页面查看 App ID。有关 App ID 的详细介绍，请参考[通用参数](https://open.feishu.cn/document/ukTMukTMukTM/uYTM5UjL2ETO14iNxkTN/terminology)。<br>**示例值：** `cli_a5d611352af9d00b` |
| response_type         | string | 是   | 应用通知授权服务器所需的授权类型，对于授权码流程，固定值`code`   <br>**示例值：** `code` |
| redirect_uri          | string | 是   | 应用重定向地址，在用户授权成功后会跳转至该地址，同时会携带 `code` 以及 `state` 参数（如有传递 `state` 参数）。<br>请注意： <br>1. 该地址需经过 URL 编码；<br>2. 调用本接口前，你需要在开发者后台应用的**安全设置**页面，将用于接受 OAuth 回调的 HTTP GET 请求接口地址配置为应用的重定向 URL。重定向 URL 支持配置多个，只有在重定向 URL 列表中的 URL 才会通过开放平台的安全校验。详情请参考[配置重定向域名](https://open.feishu.cn/document/uYjL24iN/uYjN3QjL2YzN04iN2cDN)。<br>**示例值：** `https://example.com/api/oauth/callback` |
| scope                 | string | 否   | 用户需要增量授予应用的权限。<br>**格式要求：** `scope` 参数为空格分隔，区分大小写的字符串。<br>**注意**：<br>- 开发者需要根据业务场景，在[开发者后台](https://open.larkoffice.com/app)的 **权限管理** 模块中完成调用 OpenAPI 所需的 `scope` 申请后，自主拼接 `scope` 参数。如果没有在应用后台为应用申请相应权限，则实际使用应用时用户会遇到 20027 报错。<br>- 应用最多一次可以请求用户授予 50 个 `scope`。详情参考 [API 权限列表](https://open.feishu.cn/document/ukTMukTMukTM/uYTM5UjL2ETO14iNxkTN/scope-list)。<br>- 如果后续需要获取 `refresh_token`，此处需要添加 `offline_access` 权限。详情参考 [刷新 user_access_token](https://open.feishu.cn/document/uAjLw4CM/ukTMukTMukTM/authentication-management/access-token/refresh-user-access-token)）：<br>offline_access(offline_access)  <br>**示例值：** `contact:contact bitable:app:readonly` |
| state                 | string | 否   | 用来维护请求和回调之间状态的附加字符串，在授权完成回调时会原样回传此参数。应用可以根据此字符串来判断上下文关系，同时该参数也可以用以防止 CSRF 攻击，请务必校验 `state` 参数前后是否一致。<br>**示例值：** `RANDOMSTRING` |
| code_challenge        | string | 否   | 用于通过 PKCE（Proof Key for Code Exchange）流程增强授权码的安全性。<br>**示例值：** `E9Melhoa2OwvFrEMTJguCHaoeK1t8URWbuGJSstw-cM`<br>有关 PKCE 的详细信息，请参阅[RFC-7636 - Proof Key for Code Exchange by OAuth Public Clients](https://datatracker.ietf.org/doc/html/rfc7636)。 |
| code_challenge_method | string | 否   | 生成 `code_challenge` 的方法。<br>**可选值**：  <br>1. **`S256`**（推荐）：  <br>使用 SHA-256 哈希算法计算 `code_verifier` 的哈希值，并将结果进行 Base64URL 编码，生成 `code_challenge`。  <br>2. **`plain`**（默认值）：  <br>直接将 `code_verifier` 作为 `code_challenge`，无需进行额外处理。<br>以上 `code_verifier` 是指在发起授权前，本地生成的随机字符串。 |

### 请求示例

> 注意仅为示例请求 URL，请根据前文描述将其中的查询参数替换为真实的值

``` http
https://accounts.feishu.cn/open-apis/authen/v1/authorize?client_id=cli_a5d611352af9d00b&response_type=code&redirect_uri=https%3A%2F%2Fexample.com%2Fapi%2Foauth%2Fcallback&scope=bitable:app:readonly%20contact:contact&state=RANDOMSTRING
```

## 响应

### 成功响应
当用户同意授权后，浏览器将重定向至发起授权时给定的的 `redirect_uri` 地址，同时携带 `code` 和 `state` 参数。

| 名称  | 描述                                                         |
| ----- | ------------------------------------------------------------ |
| code  | 授权码，用于获取 `user_access_token`。<br>**字符集：** [A-Z] / [a-z] / [0-9] / "-" / "_"<br>**长度：** 请开发者至少预留 64 位字符<br>**示例值：** `2Wd5g337vo5BZXUz-3W5KECsWUmIzJ_FJ1eFD59fD1AJIibIZljTu3OLK-HP_UI1` |
| state | 打开授权页时传入的 `state` 参数的原值，如未传入此处不会返回。 |

示例：
```http
https://example.com/api/oauth/callback?code=2Wd5g337vo5BZXUz-3W5KECsWUmIzJ_FJ1eFD59fD1AJIibIZljTu3OLK-HP_UI1&state=RANDOMSTRING
```

### 失败响应
当用户拒绝授权时，浏览器将重定向至发起授权时给定的 `redirect_uri` 地址，同时携带 `error` 和 `state` 查询参数。 当前 `error` 参数的固定值为 `access_denied`，请妥善处理拒绝授权时的情况。

| 名称  | 描述                                                        |
| ----- | ----------------------------------------------------------- |
| error | 错误信息，当前固定为 `access_denied`                        |
| state | 打开授权页时传入的 `state` 参数的原值，如未传入此处不会返回 |

示例：
```http
https://example.com/api/oauth/callback?error=access_denied&state=RANDOMSTRING
```

## 常见问题

### 用户授权应用时报错 20027

**问题现象**：用户在授权应用时报错 20027

![image.png](//sf3-cn.feishucdn.com/obj/open-platform-opendoc/8de8a8e0ce3fbe84ddabcbad2e929b5c_cUP75TqvF9.png?height=331&lazyload=true&maxWidth=600&width=792)

**问题原因**：打开授权页时拼接的 scope 参数中包含当前应用未开通的权限。

**解决方案**：

1. 确认需要用户授权的权限范围。
2. 前往[开发者后台](https://open.feishu.cn/app)，在对应应用的 **开发配置** > **权限管理** > **API 权限** 功能页开通相应的权限。具体操作参考[申请 API 权限](https://open.feishu.cn/document/ukTMukTMukTM/uQjN3QjL0YzN04CN2cDN)。
3. 调用当前接口，自主拼接已在应用内开通的权限。

### 如何获取包含目标权限的 user_access_token

在调用 OpenAPI 时，如果 `user_access_token` 缺少所需权限，将会返回以下错误：

```json
{
  "code": 99991679,
  "error": {
    "log_id": "202407260711088FB107A76E0100002087",
    "permission_violations": [
      {
        "subject": "task:task:read",
        "type": "action_privilege_required"
      },
      {
        "subject": "task:task:write",
        "type": "action_privilege_required"
      }
    ]
  },
  "msg": "Unauthorized. You do not have permission to perform the requested operation on the resource. Please request user re-authorization and try again. required one of these privileges: [task:task:read, task:task:write]"
}
```

为避免因 `user_access_token` 权限不足导致 OpenAPI 调用失败，开发者可通过 `scope` 查询参数请求用户授予相应权限，具体有以下两种方式：  

1. 一次性拼接所有需要用户授权的 `scope`，在无新增权限需求的情况下，无需重复授权。需注意单次拼接的 `scope` 数量上限为 50 个。  
2. 或者，根据 OpenAPI 调用返回的错误码及 `permission_violations` 字段，识别当前操作所需的额外权限。随后可重新生成授权链接，提示用户补充授权，并使用新生成的 `user_access_token` 继续调用 OpenAPI。 

建议开发者遵循最小权限原则，仅要求用户授予必要的权限。

### redirect_uri 中带 # 时的说明

标准 [RFC 3986 - Uniform Resource Identifier (URI): Generic Syntax](https://datatracker.ietf.org/doc/html/rfc3986#section-3)中约定，URI 中 `#` 后面的内容称为 fragment，位置处于 URI 最后。如果业务授权请求参数 `redirect_uri` 拼接了 `#`，授权完成后的重定向会将 `#` 和 fragment 内容拼接到 URI 最后。业务在解析获取 `code` 时需要特别注意。

`redirect_uri` 示例：

``` 
https://example.com/api/oauth/callback/#/login
```

请求示例：
``` 
GET https://accounts.feishu.cn/open-apis/authen/v1/authorize?client_id=cli_a5d611352af9d00b&redirect_uri=https%3A%2F%2Fexample.com%2Fapi%2Foauth%2Fcallback%2F%23%2Flogin%0A&scope=bitable:app:readonly%20contact:contact&state=RANDOMSTRING
```

回调后浏览器地址栏中的值示例：
```shell 
https://example.com/api/oauth/callback?code=2Wd5g337vo5BZXUz-3W5KECsWUmIzJ_FJ1eFD59fD1AJIibIZljTu3OLK-HP_UI1&state=RANDOMSTRING#/login
```

# 获取 user_access_token
OAuth 令牌接口，可用于获取 <code>user_access_token</code> 以及 <code>refresh_token</code>。<code>user_access_token</code> 为用户访问凭证，使用该凭证可以以用户身份调用 OpenAPI。<code>refresh_token</code> 为刷新凭证，可以用来获取新的 <code>user_access_token</code>。

- 获取 `user_access_token` 前需要先获取授权码，详见[获取授权码](https://open.feishu.cn/document/common-capabilities/sso/api/obtain-oauth-code)。请注意授权码的有效期为 5 分钟，且只能被使用一次。
- 用户授权时，用户必须拥有[应用的使用权限](https://open.feishu.cn/document/home/introduction-to-scope-and-authorization/availability)，否则调用本接口将会报错误码 20010。
- 获取到的 `user_access_token` 存在有效期，如何刷新 <code>user_access_token</code> 详见[刷新 user_access_token](https://open.feishu.cn/document/uAjLw4CM/ukTMukTMukTM/authentication-management/access-token/refresh-user-access-token)。
- 如果你需要获取用户信息，详见[获取用户信息](https://open.feishu.cn/document/uAjLw4CM/ukTMukTMukTM/reference/authen-v1/user_info/get)。
**注意事项**：本接口实现遵循 [RFC 6749 - The OAuth 2.0 Authorization Framework](https://datatracker.ietf.org/doc/html/rfc6749) ，你可以使用[标准的 OAuth 客户端库](https://oauth.net/code/)进行接入（**推荐**）

## 请求

| 基本                                                         | &nbsp;                                                       |
| ------------------------------------------------------------ | ------------------------------------------------------------ |
| HTTP URL                                                     | https://open.feishu.cn/open-apis/authen/v2/oauth/token       |
| HTTP Method                                                  | POST                                                         |
| 接口频率限制                                                 | [1000 次/分钟、50 次/秒](https://open.feishu.cn/document/ukTMukTMukTM/uUzN04SN3QjL1cDN) |
| 支持的应用类型                                               | Custom App、Store App                                        |
| 权限要求<br>**调用该 API 所需的权限。开启其中任意一项权限即可调用<br>** | 无                                                           |
| 字段权限要求                                                 | `refresh_token` 以及 `refresh_token_expires_in` 字段仅在具备以下权限时返回：<br>offline_access(offline_access) |

### 请求头

| 名称         | 类型   | 必填 | 描述                                                         |
| ------------ | ------ | ---- | ------------------------------------------------------------ |
| Content-Type | string | 是   | 请求体类型。<br>**固定值：**`application/json; charset=utf-8` |

### 请求体

| 名称          | 类型   | 必填 | 描述                                                         |
| ------------- | ------ | ---- | ------------------------------------------------------------ |
| grant_type    | string | 是   | 授权类型。<br>**固定值：**`authorization_code`               |
| client_id     | string | 是   | 应用的 App ID。应用凭证 App ID 和 App Secret 获取方式：<br>1. 登录[飞书开发者后台](https://open.feishu.cn/app)。<br>2. 进入应用详情页，在左侧导航栏，单击 **凭证与基础信息**。<br>3. 在 **应用凭证** 区域，获取并保存 **App ID** 和 **App Secret**。<br>**示例值：**`cli_a5ca35a685b0x26e` |
| client_secret | string | 是   | 应用的 App Secret。应用凭证 App ID 和 App Secret 获取方式：<br>1. 登录[飞书开发者后台](https://open.feishu.cn/app)。<br>2. 进入应用详情页，在左侧导航栏，单击 **凭证与基础信息**。<br>3. 在 **应用凭证** 区域，获取并保存 **App ID** 和 **App Secret**。<br>**示例值：**`baBqE5um9LbFGDy3X7LcfxQX1sqpXlwy` |
| code          | string | 是   | 授权码，详见[获取授权码](https://open.feishu.cn/document/common-capabilities/sso/api/obtain-oauth-code)。<br>**示例值：**`a61hb967bd094dge949h79bbexd16dfe` |
| redirect_uri  | string | 否   | 在构造授权页页面链接时所拼接的应用回调地址。<br>**示例值：**`https://example.com/api/oauth/callback` |
| code_verifier | string | 否   | 在发起授权前，本地生成的随机字符串，用于 PKCE（Proof Key for Code Exchange）流程。使用 PKCE 时，该值为必填项。  <br>有关 PKCE 的详细介绍，请参阅 [RFC 7636 - Proof Key for Code Exchange by OAuth Public Clients](https://datatracker.ietf.org/doc/html/rfc7636)。<br>**长度限制：** 最短 43 字符，最长 128 字符<br>**可用字符集：** [A-Z] / [a-z] / [0-9] / "-" / "." / "_" / "~"<br>**示例值：**`TxYmzM4PHLBlqm5NtnCmwxMH8mFlRWl_ipie3O0aVzo` |
| scope         | string | 否   | 该参数用于缩减 `user_access_token` 的权限范围。<br>例如：<br>1. 在[获取授权码](https://open.feishu.cn/document/common-capabilities/sso/api/obtain-oauth-code)时通过 `scope` 参数授权了 `contact:user.base:readonly contact:contact.base:readonly contact:user.employee:readonly` 三个权限。<br>2. 在当前接口可通过 `scope` 参数传入 `contact:user.base:readonly`，将 `user_access_token` 的权限缩减为 `contact:user.base:readonly` 这一个。<br>**注意**：<br>- 如果不指定当前参数，生成的 `user_access_token` 将包含用户授权时的所有权限。<br>- 当前参数不能传入重复的权限，否则会接口调用会报错，返回错误码 20067。<br>- 当前参数不能传入未授权的权限（即[获取授权码](https://open.feishu.cn/document/common-capabilities/sso/api/obtain-oauth-code)时用户已授权范围外的其他权限），否则接口调用会报错，返回错误码 20068。<br>- 多次调用当前接口缩减权限的范围不会叠加。例如，用户授予了权限 A 和 B，第一次调用该接口缩减为权限 A，则 `user_access_token` 只包含权限 A；第二次调用该接口缩减为权限 B，则 `user_access_token` 只包含权限 B。              <br>- 生效的权限列表可通过本接口返回值 scope 查看。<br>**格式要求：** 以空格分隔的 `scope` 列表<br>**示例值：**`auth:user.id:read task:task:read` |

### 请求体示例
```json
{
    "grant_type": "authorization_code",
    "client_id": "cli_a5ca35a685b0x26e",
    "client_secret": "baBqE5um9LbFGDy3X7LcfxQX1sqpXlwy",
    "code": "a61hb967bd094dge949h79bbexd16dfe",
    "redirect_uri": "https://example.com/api/oauth/callback",
    "code_verifier": "TxYmzM4PHLBlqm5NtnCmwxMH8mFlRWl_ipie3O0aVzo"
}
```
## 响应
响应体类型为 `application/json; charset=utf-8`。

### 响应体
**注意事项**：**响应体中的 `access_token` 和 `refresh_token` 长度较长**，一般在 1~2KB 之间，且可能由于 `scope` 数量的变多或后续变更导致长度进一步增加，建议预留 4KB 的存储容量

| 名称                     | 类型   | 描述                                                         |
| ------------------------ | ------ | ------------------------------------------------------------ |
| code                     | int    | 错误码，为 0 时表明请求成功，非 0 表示失败，请参照下文[错误码](#错误码)一节进行相应处理 |
| access_token             | string | 即 `user_access_token`，仅在请求成功时返回                   |
| expires_in               | int    | 即 `user_access_token` 的有效期，单位为秒，仅在请求成功时返回<br>**注意事项**：建议使用该字段以确定 `user_access_token` 的过期时间，不要硬编码有效期 |
| refresh_token            | string | 用于刷新 `user_access_token`，详见[刷新 user_access_token](https://open.feishu.cn/document/uAjLw4CM/ukTMukTMukTM/authentication-management/access-token/refresh-user-access-token)。该字段仅在请求成功且用户授予 `offline_access` 权限时返回。<br>**注意事项**：如果你在获取 `user_access_token` 时设置了 `scope` 请求参数，且需要返回 `refresh_token`，则需要在 `scope` 参数中包括 `offline_access`。另外，`refresh_token` 仅能被使用一次。 |
| refresh_token_expires_in | int    | 即 `refresh_token` 的有效期，单位为秒，仅在返回 `refresh_token` 时返回。<br>**注意事项**：建议在到期前调用[刷新 user_access_token](https://open.feishu.cn/document/uAjLw4CM/ukTMukTMukTM/authentication-management/access-token/refresh-user-access-token) 接口获取新的 `refresh_token`。 |
| token_type               | string | 值固定为 `Bearer`，仅在请求成功时返回                        |
| scope                    | string | 本次请求所获得的 `access_token` 所具备的权限列表，以空格分隔，仅在请求成功时返回 |
| error                    | string | 错误类型，仅在请求失败时返回                                 |
| error_description        | string | 具体的错误信息，仅在请求失败时返回                           |

### 响应体示例

成功响应示例：

```json
{
    "code": 0,
    "access_token": "eyJhbGciOiJFUzI1NiIs**********X6wrZHYKDxJkWwhdkrYg",
    "expires_in": 7200, // 非固定值，请务必根据响应体中返回的实际值来确定 access_token 的有效期
    "refresh_token": "eyJhbGciOiJFUzI1NiIs**********XXOYOZz1mfgIYHwM8ZJA",
    "refresh_token_expires_in": 604800, // 非固定值，请务必根据响应体中返回的实际值来确定 refresh_token 的有效期
    "scope": "auth:user.id:read offline_access task:task:read user_profile",
    "token_type": "Bearer"
}
```

失败响应示例：
```json
{
    "code": 20050,
    "error": "server_error",
    "error_description": "An unexpected server error occurred. Please retry your request."
}
```

### 错误码

| HTTP 状态码 | 错误码 | 描述                                                         | 排查建议                                                     |
| ----------- | ------ | ------------------------------------------------------------ | ------------------------------------------------------------ |
| 400         | 20001  | The request is missing a required parameter.                 | 必要参数缺失，请检查请求时传入的参数是否有误                 |
| 400         | 20002  | The client secret is invalid.                                | 应用认证失败，请检查提供的 `client_id` 与 `client_secret` 是否正确 |
| 400         | 20003  | The authorization code is not found. Please note that an authorization code can only be used once. | 无效的授权码，请检查授权码是否有效，注意授权码仅能使用一次   |
| 400         | 20004  | The authorization code has expired.                          | 授权码已经过期，请在授权码生成后的 5 分钟内使用              |
| 400         | 20008  | The user does not exist.                                     | 用户不存在，请检查发起授权的用户的当前状态                   |
| 400         | 20009  | The specified app is not installed.                          | 租户未安装应用，请检查应用状态                               |
| 400         | 20010  | The user does not have permission to use this app.           | 用户无应用使用权限，请检查发起授权的用户是否仍具有应用使用权限 |
| 400         | 20024  | The provided authorization code or refresh token does not match the provided client ID. | 提供的授权码与 `client_id` 不匹配，请勿混用不同应用的凭证    |
| 400         | 20036  | The specified grant_type is not supported.                   | 无效的 `grant_type`，请检查请求体中 `grant_type` 字段的取值  |
| 400         | 20048  | The specified app does not exist.                            | 应用不存在，请检查应用状态                                   |
| 400         | 20049  | PKCE code challenge failed.                                  | PKCE 校验失败，请检查请求体中 `code_verifier` 字段是否存在且有效 |
| 500         | 20050  | An unexpected server error occurred. Please retry your request. | 内部服务错误，请稍后重试，如果持续报错请联系[技术支持](https://applink.feishu.cn/TLJpeNdW) |
| 400         | 20063  | The request is malformed. Please check your request.         | 请求体中缺少必要字段，请根据具体的错误信息补齐字段           |
| 400         | 20065  | The authorization code has been used. Please note that an authorization code can only be used once. | 授权码已被使用，授权码仅能使用一次，请检查是否有被重复使用   |
| 400         | 20066  | The user status is invalid.                                  | 用户状态非法，请检查发起授权的用户的当前状态                 |
| 400         | 20067  | The provided scope list contains duplicate scopes. Please ensure all scopes are unique. | 无效的 `scope` 列表，其中存在重复项，请确保传入的 `scope` 列表中没有重复项 |
| 400         | 20068  | The provided scope list contains scopes that are not permitted. Please ensure all scopes are allowed. | 无效的 `scope` 列表，其中存在用户未授权的权限。当前接口 `scope` 参数传入的权限必须是[获取授权码](https://open.feishu.cn/document/common-capabilities/sso/api/obtain-oauth-code)时 `scope` 参数值的子集。<br>例如，在获取授权码时，用户授权了权限 A、B，则当前接口 `scope` 可传入的值只有权限 A、B，若传入权限 C 则会返回当前错误码。 |
| 400         | 20069  | The specified app is not enabled.                            | 应用未启用，请检查应用状态                                   |
| 400         | 20070  | Multiple authentication methods were provided. Please only use one to proceed. | 请求时同时使用了 `Basic Authentication` 和 `client_secret` 两种身份验证方式。请仅使用 `client_id`、`client_secret` 身份验证方式调用本接口。 |
| 400         | 20071  | The provided redirect URI does not match the one used during authorization. | 无效的 `redirect_uri`，请确保 `redirect_uri` 与[获取授权码](https://open.feishu.cn/document/common-capabilities/sso/api/obtain-oauth-code)时传入的 `redirect_uri` 保持一致 |
| 503         | 20072  | The server is temporarily unavailable. Please retry your request. | 服务暂不可用，请稍后重试                                     |

## 代码示例
**注意事项**：此处提供的代码示例**仅供参考**，请勿直接在生产环境使用

### Golang

运行下面示例程序的步骤：
1. 点击下方代码块右上角复制按钮，将代码复制到本地文件中，保存为 `main.go`；
2. 参照注释部分，完成配置；
3. 在 `main.go` 所在目录下新建 `.env` 文件，内容如下：
    ```bash
    APP_ID=cli_xxxxxx # 仅为示例值，请使用你的应用的 App ID，获取方式：开发者后台 -> 基础信息 -> 凭证与基础信息 -> 应用凭证 -> App ID
	APP_SECRET=xxxxxx # 仅为示例值，请使用你的应用的 App Secret，获取方式：开发者后台 -> 基础信息 -> 凭证与基础信息 -> 应用凭证 -> App Secret
    ```
4. 在 `main.go` 所在目录执行以下命令：
	```bash
    go mod init oauth-test
	go get github.com/gin-gonic/gin
	go get github.com/gin-contrib/sessions
	go get github.com/gin-contrib/sessions/cookie
	go get github.com/joho/godotenv
	go get golang.org/x/oauth2
	go run main.go
   ```
5. 浏览器打开 [http://localhost:8080](http://localhost:8080) ，按照页面提示完成授权流程；

```javascript
package main

import (
    "context"
    "encoding/json"
    "fmt"
    "log"
    "math/rand"
    "net/http"
    "os"

"github.com/gin-contrib/sessions"
    "github.com/gin-contrib/sessions/cookie"
    "github.com/gin-gonic/gin"
    _ "github.com/joho/godotenv/autoload"
    "golang.org/x/oauth2"
)

var oauthEndpoint = oauth2.Endpoint{
    AuthURL:  "https://accounts.feishu.cn/open-apis/authen/v1/authorize",
    TokenURL: "https://open.feishu.cn/open-apis/authen/v2/oauth/token",
}

var oauthConfig = &oauth2.Config{
    ClientID:     os.Getenv("APP_ID"),
    ClientSecret: os.Getenv("APP_SECRET"),
    RedirectURL:  "http://localhost:8080/callback", // 请先添加该重定向 URL，配置路径：开发者后台 -> 开发配置 -> 安全设置 -> 重定向 URL -> 添加
    Endpoint:     oauthEndpoint,
    Scopes:       []string{"offline_access"}, // 如果你不需要 refresh_token，请注释掉该行，否则你需要先申请 offline_access 权限方可使用，配置路径：开发者后台 -> 开发配置 -> 权限管理      
}

func main() {
    r := gin.Default()

// 使用 Cookie 存储 session
    store := cookie.NewStore([]byte("secret")) // 此处仅为示例，务必不要硬编码密钥
    r.Use(sessions.Sessions("mysession", store))

r.GET("/", indexController)
    r.GET("/login", loginController)
    r.GET("/callback", oauthCallbackController)

fmt.Println("Server running on http://localhost:8080")
    log.Fatal(r.Run(":8080"))
}

func indexController(c *gin.Context) {
    c.Header("Content-Type", "text/html; charset=utf-8")
    var username string
    session := sessions.Default(c)
    if session.Get("user") != nil {
       username = session.Get("user").(string)
    }
    html := fmt.Sprintf(`<html><head><style>body{font-family:Arial,sans-serif;background:#f4f4f4;margin:0;display:flex;justify-content:center;align-items:center;height:100vh}.container{text-align:center;background:#fff;padding:30px;border-radius:10px;box-shadow:0 0 10px rgba(0,0,0,0.1)}a{padding:10px 20px;font-size:16px;color:#fff;background:#007bff;border-radius:5px;text-decoration:none;transition:0.3s}a:hover{background:#0056b3}}</style></head><body>[返回主页](/)
</body></html>`, user.Data.Name)
    c.String(http.StatusOK, html)
}
```

# 刷新 user_access_token
OAuth 令牌接口，可用于刷新 <code>user_access_token</code> 以及获取新的 <code>refresh_token</code>。

- `user_access_token` 为用户访问凭证，使用该凭证可以以用户身份调用 OpenAPI，该凭证存在有效期，可通过 `refresh_token` 进行刷新。
- 用户授权时，用户必须拥有[应用的使用权限](https://open.feishu.cn/document/home/introduction-to-scope-and-authorization/availability)，否则调用本接口将会报错误码 20010。
- `refresh_token` 用于获取新的 `user_access_token`，且仅能使用一次。在获取新的 `user_access_token` 时会返回新的 `refresh_token`，原 `refresh_token` 立即失效。

- 首次获取 `refresh_token` 的方式参见[获取 user_access_token](https://open.feishu.cn/document/uAjLw4CM/ukTMukTMukTM/authentication-management/access-token/get-user-access-token)。
**注意事项**：本接口实现遵循 [RFC 6749 - The OAuth 2.0 Authorization Framework](https://datatracker.ietf.org/doc/html/rfc6749) ，你可以使用[标准的 OAuth 客户端库](https://oauth.net/code/)进行接入（**推荐**）

## 前置工作
### 开通 offline_access 权限
获取 `refresh_token` 需前往开放平台应用后台的**权限管理**模块开通 `offline_access` 权限，并在[发起授权](https://open.feishu.cn/document/common-capabilities/sso/api/obtain-oauth-code)时在 `scope` 参数中声明该权限。

![开通 offline_access 权限.png](//sf3-cn.feishucdn.com/obj/open-platform-opendoc/f8b75edae2c682ab98b6984170707a64_gYt5eNq84a.png?height=703&lazyload=true&width=1867)

在开通 `offline_access` 权限后，如需获取 `refresh_token`，具体的请求参数设置如下：
1. 首先在[发起授权](https://open.feishu.cn/document/common-capabilities/sso/api/obtain-oauth-code)时，授权链接的`scope` 参数中必须拼接 `offline_access`，例如：
```
https://accounts.feishu.cn/open-apis/authen/v1/authorize?client_id=cli_a5d611352af9d00b&redirect_uri=https%3A%2F%2Fexample.com%2Fapi%2Foauth%2Fcallback&scope=bitable:app:readonly%20offline_access
```
2. 在[获取 user_access_token](https://open.feishu.cn/document/uAjLw4CM/ukTMukTMukTM/authentication-management/access-token/get-user-access-token)时，
	+ 如果不需要缩减权限，即该接口的 `scope` 参数为空，则无需做其他操作，即可正常获得 `refresh_token`；
	+ 如果需要缩减权限，即该接口的 `scope` 参数不为空，
		+ 且需要获取 `refresh_token`，则此处的 `scope` 参数中需要拼接 `offline_access`；
		+ 如不需要获取 `refresh_token`，则无需特殊处理；
3. 在[刷新 user_access_token](https://open.feishu.cn/document/uAjLw4CM/ukTMukTMukTM/authentication-management/access-token/refresh-user-access-token)时，同第二步的逻辑。

### 开启刷新 user_access_token 的安全设置
**注意事项**：- 如果你看不到此开关则无需关注，其默认处于开启状态。
- 完成配置后需要发布应用使配置生效。具体操作参见[发布企业自建应用](https://open.feishu.cn/document/home/introduction-to-custom-app-development/self-built-application-development-process#baf09c7d)、[发布商店应用](https://open.feishu.cn/document/uMzNwEjLzcDMx4yM3ATM/uYjMyUjL2IjM14iNyITN)。

前往开放平台应用后台的**安全设置**模块，打开刷新 `user_access_token` 的开关。

![开启刷新 user_access_token 的安全设置.png](//sf3-cn.feishucdn.com/obj/open-platform-opendoc/194824525c33e70cd796579744571c2d_WbBjYQW3zR.png?height=796&lazyload=true&width=1907)

## 请求
**注意事项**：为了避免刷新 `user_access_token` 的行为被滥用，在用户授权应用 365 天后，应用必须通过用户[重新授权](https://open.feishu.cn/document/uAjLw4CM/ukTMukTMukTM/authentication-management/access-token/get-user-access-token)的方式来获取 `user_access_token` 与 `refresh_token`。如果 `refresh_token` 到期后继续刷新`user_access_token`将报错（错误码为 20037），可参考以下[错误码描述信息](#错误码)进行处理。
**注意事项**：刷新后请更新本地 `user_access_token` 和 `refresh_token`，原令牌将无法再使用（`user_access_token` 会有一分钟的豁免时间以供应用完成令牌轮转）。

| 基本                                                         | &nbsp;                                                       |
| ------------------------------------------------------------ | ------------------------------------------------------------ |
| HTTP URL                                                     | https://open.feishu.cn/open-apis/authen/v2/oauth/token       |
| HTTP Method                                                  | POST                                                         |
| 接口频率限制                                                 | [1000 次/分钟、50 次/秒](https://open.feishu.cn/document/ukTMukTMukTM/uUzN04SN3QjL1cDN) |
| 支持的应用类型                                               | Custom App、Store App                                        |
| 权限要求<br>**调用该 API 所需的权限。开启其中任意一项权限即可调用<br>** | 无                                                           |
| 字段权限要求                                                 | `refresh_token` 以及 `refresh_token_expires_in` 字段仅在具备以下权限时返回：<br>offline_access(offline_access) |

### 请求头

| 名称         | 类型   | 必填 | 描述                                                         |
| ------------ | ------ | ---- | ------------------------------------------------------------ |
| Content-Type | string | 是   | 请求体类型。<br>**固定值：**`application/json; charset=utf-8` |

### 请求体

| 名称          | 类型   | 必填 | 描述                                                         |
| ------------- | ------ | ---- | ------------------------------------------------------------ |
| grant_type    | string | 是   | 授权类型。<br>**固定值：**`refresh_token`                    |
| client_id     | string | 是   | 应用的 App ID，可以在开发者后台中的应用详情页面找到该值。<br>**示例值：**`cli_a5ca35a685b0x26e` |
| client_secret | string | 是   | 应用的 App Secret，可以在开发者后台中的应用详情页面找到该值，详见：[如何获取应用的 App ID](https://open.feishu.cn/document/uAjLw4CM/ugTN1YjL4UTN24CO1UjN/trouble-shooting/how-to-obtain-app-id)。<br>**示例值：**`baBqE5um9LbFGDy3X7LcfxQX1sqpXlwy` |
| refresh_token | string | 是   | 刷新令牌，用于刷新 `user_access_token` 以及 `refresh_token`。<br>**注意事项**：请务必注意本接口仅支持[获取 user_access_token](https://open.feishu.cn/document/uAjLw4CM/ukTMukTMukTM/authentication-management/access-token/get-user-access-token)和[刷新 user_access_token](https://open.feishu.cn/document/uAjLw4CM/ukTMukTMukTM/authentication-management/access-token/refresh-user-access-token)接口返回的 `refresh_token`<br>**示例值：**`eyJhbGciOiJFUzI1NiIs**********XXOYOZz1mfgIYHwM8ZJA` |
| scope         | string | 否   | 该参数用于缩减 `user_access_token` 的权限范围。<br>例如：<br>1. 在[获取授权码](https://open.feishu.cn/document/common-capabilities/sso/api/obtain-oauth-code)时通过 `scope` 参数授权了 `contact:user.base:readonly contact:contact.base:readonly contact:user.employee:readonly` 三个权限。<br>2. 在当前接口可通过 `scope` 参数传入 `contact:user.base:readonly`，将 `user_access_token` 的权限缩减为 `contact:user.base:readonly` 这一个。<br>**注意**：<br>- 如果不指定当前参数，生成的 `user_access_token` 将包含用户授权时的所有权限。<br>- 当前参数不能传入重复的权限，否则会接口调用会报错，返回错误码 20067。<br>- 当前参数不能传入未授权的权限（即[获取授权码](https://open.feishu.cn/document/common-capabilities/sso/api/obtain-oauth-code)时用户已授权范围外的其他权限），否则接口调用会报错，返回错误码 20068。<br>- 多次调用当前接口缩减权限的范围不会叠加。例如，用户授予了权限 A 和 B，第一次调用该接口缩减为权限 A，则 `user_access_token` 只包含权限 A；第二次调用该接口缩减为权限 B，则 `user_access_token` 只包含权限 B。              <br>- 生效的权限列表可通过本接口返回值 scope 查看。<br>**格式要求：** 以空格分隔的 `scope` 列表<br>**示例值：**`auth:user.id:read task:task:read` |

### 请求体示例
```json
{
    "grant_type": "refresh_token",
    "client_id": "cli_a5ca35a685b0x26e",
    "client_secret": "baBqE5um9LbFGDy3X7LcfxQX1sqpXlwy",
    "refresh_token": "eyJhbGciOiJFUzI1NiIs**********XXOYOZz1mfgIYHwM8ZJA"
}
```
## 响应
响应体类型为 `application/json; charset=utf-8`。

### 响应体

| 名称                     | 类型   | 描述                                                         |
| ------------------------ | ------ | ------------------------------------------------------------ |
| code                     | int    | 错误码，为 0 时表明请求成功，非 0 表示失败，请参照下文错误码一节妥善处理 |
| access_token             | string | 即 `user_access_token`，仅在请求成功时返回                   |
| expires_in               | int    | 即 `user_access_token` 的有效期，单位为秒，仅在请求成功时返回<br>**注意事项**：建议使用该字段以确定 `user_access_token` 的过期时间，不要硬编码有效期 |
| refresh_token            | string | 用于刷新 `user_access_token`，该字段仅在请求成功且用户授予 `offline_access` 权限时返回：<br>offline_access(offline_access)<br>**注意事项**：如果你在获取 `user_access_token` 时设置了 `scope` 请求参数，且需要返回 `refresh_token`，则需要在 `scope` 参数中包括 `offline_access`。另外，`refresh_token` 仅能被使用一次。 |
| refresh_token_expires_in | int    | 即 `refresh_token` 的有效期，单位为秒，仅在返回 `refresh_token` 时返回。<br>**注意事项**：建议在到期前重新调用当前接口获取新的 `refresh_token`。 |
| token_type               | string | 值固定为 `Bearer`，仅在请求成功时返回                        |
| scope                    | string | 本次请求所获得的 `access_token` 所具备的权限列表，以空格分隔，仅在请求成功时返回 |
| error                    | string | 错误类型，仅在请求失败时返回                                 |
| error_description        | string | 具体的错误信息，仅在请求失败时返回                           |

### 响应体示例

成功响应示例：

```json
{
    "code": 0,
    "access_token": "eyJhbGciOiJFUzI1NiIs**********X6wrZHYKDxJkWwhdkrYg",
    "expires_in": 7200, // 非固定值，请务必根据响应体中返回的实际值来确定 access_token 的有效期
    "refresh_token": "eyJhbGciOiJFUzI1NiIs**********VXOYOZYZmfgIYHWM0ZJA",
    "refresh_token_expires_in": 604800, // 非固定值，请务必根据响应体中返回的实际值来确定 refresh_token 的有效期
    "scope": "auth:user.id:read offline_access task:task:read user_profile",
    "token_type": "Bearer"
}
```

失败响应示例：
```json
{
    "code": 20050,
    "error": "server_error",
    "error_description": "An unexpected server error occurred. Please retry your request."
}
```

### 错误码

| HTTP 状态码 | 错误码 | 描述                                                         | 排查建议                                                     |
| ----------- | ------ | ------------------------------------------------------------ | ------------------------------------------------------------ |
| 400         | 20001  | The request is missing a required parameter.                 | 必要参数缺失，请检查请求时传入的参数是否有误                 |
| 400         | 20002  | The client secret is invalid.                                | 应用认证失败，请检查提供的 `client_id` 与 `client_secret` 是否正确。获取方式参见 [如何获取应用的 App ID](https://open.feishu.cn/document/uAjLw4CM/ugTN1YjL4UTN24CO1UjN/trouble-shooting/how-to-obtain-app-id)。 |
| 400         | 20008  | The user does not exist.                                     | 用户不存在，请检查发起授权的用户的当前状态                   |
| 400         | 20009  | The specified app is not installed.                          | 租户未安装应用，请检查应用状态                               |
| 400         | 20010  | The user does not have permission to use this app.           | 用户无应用使用权限，请检查发起授权的用户是否仍具有应用使用权限 |
| 400         | 20024  | The provided authorization code or refresh token does not match the provided client ID. | 提供的 `refresh_token` 与 `client_id` 不匹配，请勿混用不同应用的凭证 |
| 400         | 20026  | The refresh token passed is invalid. Please check the value. | 请检查请求体中 `refresh_token` 字段的取值<br>请注意本接口仅支持 v2 版本接口下发的 `refresh_token` |
| 400         | 20036  | The specified grant_type is not supported.                   | 无效的 `grant_type`，请检查请求体中 `grant_type` 字段的取值  |
| 400         | 20037  | The refresh token passed has expired. Please generate a new one. | `refresh_token` 已过期，请[重新发起授权流程](https://open.feishu.cn/document/uAjLw4CM/ukTMukTMukTM/authentication-management/access-token/get-user-access-token)以获取新的 `refresh_token` |
| 400         | 20048  | The specified app does not exist.                            | 应用不存在，请检查应用状态                                   |
| 500         | 20050  | An unexpected server error occurred. Please retry your request. | 内部服务错误，请稍后重试，如果持续报错请联系[技术支持](https://applink.feishu.cn/TLJpeNdW) |
| 400         | 20063  | The request is malformed. Please check your request.         | 请求体中缺少必要字段，请根据具体的错误信息补齐字段           |
| 400         | 20064  | The refresh token has been revoked. Please note that a refresh token can only be used once. | `refresh_token` 已被撤销，请[重新发起授权流程](https://open.feishu.cn/document/uAjLw4CM/ukTMukTMukTM/authentication-management/access-token/get-user-access-token)以获取新的 `refresh_token` |
| 400         | 20066  | The user status is invalid.                                  | 用户状态非法，请检查发起授权的用户的当前状态                 |
| 400         | 20067  | The provided scope list contains duplicate scopes. Please ensure all scopes are unique. | 无效的 `scope` 列表，其中存在重复项，请确保传入的 `scope` 列表中没有重复项 |
| 400         | 20068  | The provided scope list contains scopes that are not permitted. Please ensure all scopes are allowed. | 无效的 `scope` 列表，其中存在用户未授权的权限。当前接口 `scope` 参数传入的权限必须是[获取授权码](https://open.feishu.cn/document/common-capabilities/sso/api/obtain-oauth-code)时 `scope` 参数值的子集。<br>例如，在获取授权码时，用户授权了权限 A、B，则当前接口 `scope` 可传入的值只有权限 A、B，若传入权限 C 则会返回当前错误码。 |
| 400         | 20069  | The specified app is not enabled.                            | 应用未启用，请检查应用状态                                   |
| 400         | 20070  | Multiple authentication methods were provided. Please only use one to proceed. | 请求时同时使用了 `Basic Authentication` 和 `client_secret` 两种身份验证方式。请仅使用 `client_id`、`client_secret` 身份验证方式调用本接口。 |
| 503         | 20072  | The server is temporarily unavailable. Please retry your request. | 服务暂不可用，请稍后重试                                     |
| 400         | 20073  | The refresh token has been used. Please note that a refresh token can only be used once. | 请[重新发起授权流程](https://open.feishu.cn/document/uAjLw4CM/ukTMukTMukTM/authentication-management/access-token/get-user-access-token)以获取新的 `refresh_token` |
| 400         | 20074  | The specified app is not allowed to refresh token.           | 请在应用管理后台检查是否开启了刷新 `user_access_token` 开关，注意发版后生效 |